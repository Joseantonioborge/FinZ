<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinX ‚Äî Dashboard de Negocio</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --teal: #0DBFAD;
    --teal-light: #E0FAF8;
    --teal-mid: #5ED8CF;
    --blue: #2563EB;
    --blue-light: #EFF6FF;
    --indigo: #4F46E5;
    --orange: #F97316;
    --orange-light: #FFF7ED;
    --green: #16A34A;
    --green-light: #F0FDF4;
    --red: #DC2626;
    --red-light: #FEF2F2;
    --yellow: #D97706;
    --yellow-light: #FFFBEB;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-500: #6B7280;
    --gray-700: #374151;
    --gray-900: #111827;
    --white: #FFFFFF;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 4px 16px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.10);
    --radius: 16px;
    --radius-sm: 10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--gray-50);
    color: var(--gray-900);
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  header {
    background: var(--white);
    border-bottom: 1px solid var(--gray-200);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 68px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-sm);
  }

  .logo-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* SVG Logo */
  .finx-logo-svg {
    width: 44px;
    height: 44px;
    flex-shrink: 0;
  }

  .logo-text {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    background: linear-gradient(135deg, #0DBFAD 0%, #2563EB 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
  }

  .logo-sub {
    font-size: 11px;
    font-weight: 500;
    color: var(--gray-500);
    letter-spacing: 1.2px;
    text-transform: uppercase;
    margin-top: -2px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .badge-live {
    background: var(--green-light);
    color: var(--green);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .badge-live::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* ===== NAV TABS ===== */
  .nav-tabs {
    background: var(--white);
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    overflow-x: auto;
    padding: 0 24px;
    gap: 0;
  }

  .nav-tab {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 14px 18px;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--gray-500);
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.2s;
  }

  .nav-tab:hover { color: var(--teal); }
  .nav-tab.active {
    color: var(--teal);
    border-bottom-color: var(--teal);
    font-weight: 600;
  }

  /* ===== MAIN ===== */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 28px 24px;
  }

  .section { display: none; }
  .section.active { display: block; }

  /* ===== GRID ===== */
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 24px; }
  .grid-2-1 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }

  @media (max-width: 1100px) {
    .grid-4 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 700px) {
    .grid-4, .grid-2, .grid-3, .grid-1-2, .grid-2-1 { grid-template-columns: 1fr; }
    main { padding: 16px 12px; }
    header { padding: 0 16px; }
  }

  /* ===== CARDS ===== */
  .card {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    padding: 22px;
    transition: box-shadow 0.2s;
  }

  .card:hover { box-shadow: var(--shadow); }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .card-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* ===== KPI CARDS ===== */
  .kpi-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 20px 22px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--gray-200);
    position: relative;
    overflow: hidden;
    transition: all 0.2s;
  }

  .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .kpi-card.teal::before { background: linear-gradient(90deg, var(--teal), var(--teal-mid)); }
  .kpi-card.blue::before { background: linear-gradient(90deg, var(--blue), var(--indigo)); }
  .kpi-card.orange::before { background: linear-gradient(90deg, var(--orange), #FBBF24); }
  .kpi-card.green::before { background: linear-gradient(90deg, var(--green), #4ADE80); }
  .kpi-card.indigo::before { background: linear-gradient(90deg, var(--indigo), #818CF8); }

  .kpi-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    margin-bottom: 12px;
  }

  .kpi-icon.teal { background: var(--teal-light); }
  .kpi-icon.blue { background: var(--blue-light); }
  .kpi-icon.orange { background: var(--orange-light); }
  .kpi-icon.green { background: var(--green-light); }
  .kpi-icon.indigo { background: #EEF2FF; }

  .kpi-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin-bottom: 4px;
  }

  .kpi-value {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    color: var(--gray-900);
    line-height: 1;
    margin-bottom: 6px;
  }

  .kpi-delta {
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 3px;
  }

  .kpi-delta.up { color: var(--green); }
  .kpi-delta.down { color: var(--red); }

  /* ===== TABLE ===== */
  .table-wrap { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  thead th {
    background: var(--gray-50);
    padding: 10px 14px;
    text-align: right;
    font-weight: 600;
    color: var(--gray-700);
    border-bottom: 2px solid var(--gray-200);
    white-space: nowrap;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
  }

  thead th:first-child { text-align: left; }

  tbody tr {
    border-bottom: 1px solid var(--gray-100);
    transition: background 0.15s;
  }

  tbody tr:hover { background: var(--gray-50); }

  tbody td {
    padding: 10px 14px;
    text-align: right;
    color: var(--gray-700);
    white-space: nowrap;
  }

  tbody td:first-child {
    text-align: left;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    color: var(--teal);
  }

  .positive { color: var(--green); font-weight: 600; }
  .negative { color: var(--red); font-weight: 600; }

  /* ===== SECTION TITLE ===== */
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--gray-900);
    margin-bottom: 6px;
  }

  .section-desc {
    font-size: 14px;
    color: var(--gray-500);
    margin-bottom: 24px;
  }

  /* ===== SIMULATOR ===== */
  .sim-section {
    background: linear-gradient(135deg, #F0FDFA 0%, #EFF6FF 100%);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
  }

  .sim-title {
    font-family: 'Syne', sans-serif;
    font-size: 18px;
    font-weight: 800;
    color: var(--gray-900);
    margin-bottom: 4px;
  }

  .sim-desc {
    font-size: 13px;
    color: var(--gray-500);
    margin-bottom: 20px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }

  @media (max-width: 900px) {
    .form-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
  }

  .form-group { display: flex; flex-direction: column; gap: 6px; }

  label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  input[type="number"], select {
    padding: 10px 14px;
    border: 1.5px solid var(--gray-300);
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--gray-900);
    background: var(--white);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  input[type="number"]:focus, select:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(13,191,173,0.12);
  }

  .input-prefix {
    position: relative;
  }

  .input-prefix span {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-500);
    font-size: 14px;
    pointer-events: none;
  }

  .input-prefix input {
    padding-left: 28px;
  }

  .btn-calc {
    padding: 12px 28px;
    background: linear-gradient(135deg, var(--teal) 0%, var(--blue) 100%);
    color: white;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .btn-calc:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(13,191,173,0.4);
  }

  .btn-secondary {
    padding: 12px 20px;
    background: var(--white);
    color: var(--gray-700);
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 600;
    border: 1.5px solid var(--gray-300);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    border-color: var(--teal);
    color: var(--teal);
  }

  .btn-group { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

  /* ===== RESULT BOX ===== */
  .result-box {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-top: 20px;
  }

  @media (max-width: 800px) {
    .result-box { grid-template-columns: repeat(2, 1fr); }
  }

  .result-item {
    background: var(--white);
    border-radius: var(--radius-sm);
    padding: 16px;
    border: 1px solid var(--gray-200);
    text-align: center;
  }

  .result-item .rl { font-size: 11px; color: var(--gray-500); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
  .result-item .rv {
    font-family: 'Syne', sans-serif;
    font-size: 20px;
    font-weight: 800;
    color: var(--gray-900);
  }

  .result-item.highlight-green { border-color: var(--green); background: var(--green-light); }
  .result-item.highlight-green .rv { color: var(--green); }
  .result-item.highlight-red { border-color: var(--red); background: var(--red-light); }
  .result-item.highlight-red .rv { color: var(--red); }

  /* ===== TAX SIMULATOR ===== */
  .tax-table {
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .tax-q {
    display: grid;
    grid-template-columns: auto 1fr 1fr 1fr;
    align-items: center;
    padding: 14px 20px;
    border-bottom: 1px solid var(--gray-100);
    gap: 16px;
  }

  .tax-q:last-child { border-bottom: none; }

  .tax-q-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    color: var(--teal);
    min-width: 60px;
  }

  .tax-q-dates { font-size: 12px; color: var(--gray-500); }
  .tax-q-amount { font-weight: 600; font-size: 15px; text-align: right; color: var(--gray-900); }
  .tax-q-status {
    text-align: right;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-block;
  }

  .status-pending { background: var(--yellow-light); color: var(--yellow); }
  .status-due { background: var(--red-light); color: var(--red); }
  .status-paid { background: var(--green-light); color: var(--green); }

  /* ===== PROGRESS BAR ===== */
  .progress-bar {
    height: 6px;
    background: var(--gray-100);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 8px;
  }

  .progress-fill {
    height: 100%;
    border-radius: 3px;
    background: linear-gradient(90deg, var(--teal), var(--blue));
    transition: width 0.8s ease;
  }

  /* ===== CHART CONTAINERS ===== */
  .chart-container {
    position: relative;
    height: 280px;
    width: 100%;
  }

  .chart-container.tall { height: 340px; }
  .chart-container.short { height: 200px; }

  /* ===== COHORT GRID ===== */
  .cohort-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 6px;
    margin-top: 8px;
  }

  .cohort-cell {
    aspect-ratio: 1;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: white;
  }

  /* ===== KPI SPARKLINE ===== */
  .sparkline-wrap { display: flex; align-items: flex-end; gap: 3px; height: 30px; }
  .sparkline-bar {
    flex: 1;
    border-radius: 2px 2px 0 0;
    min-height: 4px;
    background: linear-gradient(180deg, var(--teal), var(--teal-mid));
    opacity: 0.7;
    transition: opacity 0.2s;
  }
  .sparkline-bar:hover { opacity: 1; }

  /* ===== SCROLLABLE CHART ROW ===== */
  .scrollable-table { overflow-x: auto; }

  /* ===== USER CORRECTION PANEL ===== */
  .correction-panel {
    background: linear-gradient(135deg, #F0FDFA 0%, #EFF6FF 100%);
    border: 1.5px solid var(--teal);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }

  .correction-panel::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 120px; height: 120px;
    border-radius: 50%;
    background: rgba(13,191,173,0.08);
  }

  .correction-panel-title {
    font-family: 'Syne', sans-serif;
    font-size: 16px;
    font-weight: 800;
    color: var(--gray-900);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .correction-panel-desc {
    font-size: 13px;
    color: var(--gray-500);
    margin-bottom: 20px;
  }

  .correction-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  @media (max-width: 1100px) { .correction-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 700px)  { .correction-grid { grid-template-columns: repeat(2, 1fr); } }

  .correction-field {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .correction-field label {
    font-size: 11px;
    font-weight: 700;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .correction-field .year-tag {
    font-family: 'Syne', sans-serif;
    font-size: 12px;
    font-weight: 800;
    color: var(--teal);
    margin-bottom: 2px;
  }

  .correction-input-wrap {
    position: relative;
  }

  .correction-input-wrap input {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--gray-300);
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--gray-900);
    background: var(--white);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  .correction-input-wrap input:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(13,191,173,0.12);
  }

  .correction-input-wrap input.has-override {
    border-color: var(--orange);
    background: var(--orange-light);
    font-weight: 600;
    color: var(--orange);
  }

  .correction-input-wrap .reset-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-400);
    font-size: 13px;
    padding: 2px;
    line-height: 1;
    transition: color 0.2s;
    display: none;
  }

  .correction-input-wrap input.has-override ~ .reset-btn {
    display: block;
    color: var(--orange);
  }

  .correction-input-wrap .reset-btn:hover { color: var(--red); }

  .deviation-chip {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 10px;
    display: inline-block;
    margin-top: 4px;
  }

  .deviation-chip.positive { background: var(--green-light); color: var(--green); }
  .deviation-chip.negative { background: var(--red-light); color: var(--red); }
  .deviation-chip.neutral  { background: var(--gray-100); color: var(--gray-500); }

  .correction-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 4px;
  }

  .impact-banner {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed rgba(13,191,173,0.4);
  }

  @media (max-width: 800px) { .impact-banner { grid-template-columns: repeat(2, 1fr); } }

  .impact-item {
    text-align: center;
    padding: 10px;
    background: var(--white);
    border-radius: var(--radius-sm);
    border: 1px solid var(--gray-200);
  }

  .impact-item .il { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray-500); font-weight: 600; margin-bottom: 4px; }
  .impact-item .iv { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; color: var(--gray-900); }
  .impact-item .id { font-size: 11px; font-weight: 600; margin-top: 2px; }
  .impact-item .id.up { color: var(--green); }
  .impact-item .id.down { color: var(--red); }

  .mode-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .mode-badge.original { background: var(--gray-100); color: var(--gray-500); }
  .mode-badge.adjusted { background: var(--orange-light); color: var(--orange); }
  .mode-badge.adjusted::before { content: '‚óè'; font-size: 8px; animation: pulse 1.5s infinite; }

  /* ===== DOWNLOAD BUTTONS ===== */
  .download-bar {
    position: fixed;
    bottom: 24px;
    right: 24px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 200;
  }

  .btn-download {
    display: flex;
    align-items: center;
    gap: 9px;
    padding: 11px 20px;
    border-radius: 50px;
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transition: all 0.22s;
    white-space: nowrap;
    letter-spacing: 0.2px;
    text-decoration: none;
  }

  .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 28px rgba(0,0,0,0.22);
  }

  .btn-download:active { transform: translateY(0); }

  .btn-download.excel {
    background: linear-gradient(135deg, #16A34A 0%, #15803D 100%);
    color: white;
  }

  .btn-download.csv {
    background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
    color: white;
  }

  .btn-download .dl-icon {
    font-size: 16px;
    line-height: 1;
  }

  /* Tooltip on hover */
  .download-bar-label {
    font-size: 10px;
    text-align: right;
    color: var(--gray-500);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }

  @media (max-width: 600px) {
    .download-bar { bottom: 16px; right: 12px; }
    .btn-download { padding: 10px 14px; font-size: 12px; }
  }
    text-align: center;
    padding: 20px;
    font-size: 12px;
    color: var(--gray-500);
    border-top: 1px solid var(--gray-200);
    margin-top: 40px;
  }

  /* ===== COST CORRECTION PANEL ===== */
  .cost-correction-panel {
    background: linear-gradient(135deg, #FFF7ED 0%, #FFFBEB 100%);
    border: 1.5px solid var(--orange);
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }

  .cost-correction-panel::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 120px; height: 120px;
    border-radius: 50%;
    background: rgba(249,115,22,0.07);
  }

  .cost-correction-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 16px;
  }

  @media (max-width: 1100px) { .cost-correction-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 700px)  { .cost-correction-grid { grid-template-columns: repeat(2, 1fr); } }

  .cost-input-wrap { position: relative; }

  .cost-input-wrap input {
    width: 100%;
    padding: 9px 28px 9px 12px;
    border: 1.5px solid var(--gray-300);
    border-radius: var(--radius-sm);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--gray-900);
    background: var(--white);
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  .cost-input-wrap input:focus {
    border-color: var(--orange);
    box-shadow: 0 0 0 3px rgba(249,115,22,0.12);
  }

  .cost-input-wrap input.has-cost-override {
    border-color: var(--orange);
    background: #FFF7ED;
    font-weight: 600;
    color: #C2410C;
  }

  .cost-input-wrap .cost-reset-btn {
    position: absolute;
    right: 8px; top: 50%;
    transform: translateY(-50%);
    background: none; border: none; cursor: pointer;
    color: var(--gray-400); font-size: 13px; padding: 2px; line-height: 1;
    transition: color 0.2s; display: none;
  }

  .cost-input-wrap input.has-cost-override ~ .cost-reset-btn { display: block; color: var(--orange); }
  .cost-input-wrap .cost-reset-btn:hover { color: var(--red); }

  .mode-badge.cost-adjusted { background: var(--orange-light); color: var(--orange); }
  .mode-badge.cost-adjusted::before { content: '‚óè'; font-size: 8px; animation: pulse 1.5s infinite; margin-right: 3px; }

  .cost-category-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 18px;
    flex-wrap: wrap;
    align-items: center;
  }

  .cost-cat-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--gray-700);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 4px;
  }

  .cost-cat-btn {
    padding: 6px 14px;
    border-radius: 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 600;
    border: 1.5px solid var(--gray-300);
    background: var(--white);
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.18s;
    white-space: nowrap;
  }

  .cost-cat-btn:hover { border-color: var(--orange); color: var(--orange); }
  .cost-cat-btn.active { background: var(--orange); border-color: var(--orange); color: white; }
  .tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }

  .tag.teal { background: var(--teal-light); color: var(--teal); }
  .tag.blue { background: var(--blue-light); color: var(--blue); }
  .tag.orange { background: var(--orange-light); color: var(--orange); }

  /* ===== DIVIDER ===== */
  .divider { height: 1px; background: var(--gray-200); margin: 20px 0; }

  /* ===== HERO METRICS ===== */
  .hero-banner {
    background: linear-gradient(135deg, #0DBFAD 0%, #2563EB 100%);
    border-radius: var(--radius);
    padding: 28px 32px;
    color: white;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    position: relative;
    overflow: hidden;
  }

  .hero-banner::after {
    content: '';
    position: absolute;
    right: -40px;
    top: -40px;
    width: 200px;
    height: 200px;
    border-radius: 50%;
    background: rgba(255,255,255,0.07);
  }

  .hero-text h2 {
    font-family: 'Syne', sans-serif;
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 4px;
  }

  .hero-text p {
    font-size: 14px;
    opacity: 0.85;
  }

  .hero-metrics {
    display: flex;
    gap: 32px;
    flex-wrap: wrap;
  }

  .hero-m { text-align: center; }
  .hero-m .hv {
    font-family: 'Syne', sans-serif;
    font-size: 24px;
    font-weight: 800;
    display: block;
  }
  .hero-m .hl { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.6px; }

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo-wrap">
    <!-- SVG Logo FinX -->
    <svg class="finx-logo-svg" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="44" height="44" rx="12" fill="url(#grad1)"/>
      <defs>
        <linearGradient id="grad1" x1="0" y1="0" x2="44" y2="44" gradientUnits="userSpaceOnUse">
          <stop offset="0%" stop-color="#0DBFAD"/>
          <stop offset="100%" stop-color="#2563EB"/>
        </linearGradient>
      </defs>
      <!-- F shape -->
      <rect x="10" y="11" width="3" height="22" rx="1.5" fill="white"/>
      <rect x="10" y="11" width="12" height="3" rx="1.5" fill="white"/>
      <rect x="10" y="20" width="9" height="3" rx="1.5" fill="white"/>
      <!-- X shape -->
      <line x1="24" y1="11" x2="36" y2="33" stroke="white" stroke-width="3" stroke-linecap="round"/>
      <line x1="36" y1="11" x2="24" y2="33" stroke="white" stroke-width="3" stroke-linecap="round"/>
    </svg>
    <div>
      <div class="logo-text">FinX</div>
      <div class="logo-sub">Neobanco Digital</div>
    </div>
  </div>
  <div class="header-right">
    <div class="badge-live">En vivo</div>
    <div style="font-size:12px; color:var(--gray-500);">Modelo 2026‚Äì2035</div>
  </div>
</header>

<!-- NAV TABS -->
<nav class="nav-tabs">
  <button class="nav-tab active" onclick="showSection('overview', this)">üìä Overview</button>
  <button class="nav-tab" onclick="showSection('financials', this)">üí∞ Financials</button>
  <button class="nav-tab" onclick="showSection('users', this)">üë• Usuarios</button>
  <button class="nav-tab" onclick="showSection('simulator', this)">üßÆ Simulador Personal</button>
  <button class="nav-tab" onclick="showSection('taxes', this)">üìã Impuestos</button>
  <button class="nav-tab" onclick="showSection('kpis', this)">üéØ KPIs</button>
</nav>

<main>

  <!-- ========= OVERVIEW ========= -->
  <section id="overview" class="section active">

    <div class="hero-banner">
      <div class="hero-text">
        <h2>Dashboard FinX 2026‚Äì2035 <span id="overviewAdjBadge" style="display:none;font-size:13px;font-weight:600;background:rgba(255,255,255,0.25);padding:3px 10px;border-radius:20px;vertical-align:middle;letter-spacing:0.3px;">‚ö° Modelo Ajustado</span></h2>
        <p>Proyecci√≥n financiera ¬∑ Wallet digital ¬∑ GenZ Espa√±a</p>
      </div>
      <div class="hero-metrics">
        <div class="hero-m">
          <span class="hv" id="heroUsers">4.85M</span>
          <span class="hl">Usuarios 2035</span>
        </div>
        <div class="hero-m">
          <span class="hv" id="heroRev">‚Ç¨327M</span>
          <span class="hl">Ingresos 2035</span>
        </div>
        <div class="hero-m">
          <span class="hv" id="heroEbitda">‚Ç¨245M</span>
          <span class="hl">EBITDA 2035</span>
        </div>
        <div class="hero-m">
          <span class="hv" id="heroMargin">74.8%</span>
          <span class="hl">Margen EBITDA</span>
        </div>
      </div>
    </div>

    <div class="grid-4">
      <div class="kpi-card teal">
        <div class="kpi-icon teal">üë•</div>
        <div class="kpi-label">Usuarios Activos 2026</div>
        <div class="kpi-value" id="kpiUsers2026">564K</div>
        <div class="kpi-delta up" id="kpiUsers2026Delta">‚ñ≤ A√±o de lanzamiento</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-icon blue">üí≥</div>
        <div class="kpi-label">Ingresos Totales 2026</div>
        <div class="kpi-value" id="kpiRev2026">‚Ç¨38M</div>
        <div class="kpi-delta up" id="kpiRev2026Delta">‚ñ≤ Base s√≥lida</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-icon green">üìà</div>
        <div class="kpi-label">EBITDA 2026</div>
        <div class="kpi-value" id="kpiEbitda2026">‚Ç¨28M</div>
        <div class="kpi-delta up" id="kpiEbitda2026Delta">‚ñ≤ 73.7% margen</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon orange">üèÜ</div>
        <div class="kpi-label">LTV / CAC</div>
        <div class="kpi-value">7.18x</div>
        <div class="kpi-delta up">‚ñ≤ Excelente ratio</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Ingresos Totales vs EBITDA</div>
          <span class="tag teal">10 a√±os</span>
        </div>
        <div class="chart-container">
          <canvas id="chartRevEbitda"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Crecimiento de Usuarios</div>
          <span class="tag blue">Activos</span>
        </div>
        <div class="chart-container">
          <canvas id="chartUsers"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-3">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Mix de Ingresos 2035</div>
        </div>
        <div class="chart-container short">
          <canvas id="chartMix"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Starter vs Premium</div>
        </div>
        <div class="chart-container short">
          <canvas id="chartTiers"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Margen EBITDA %</div>
          <span class="tag orange">Evoluci√≥n</span>
        </div>
        <div class="chart-container short">
          <canvas id="chartMargin"></canvas>
        </div>
      </div>
    </div>

  </section>

  <!-- ========= FINANCIALS ========= -->
  <section id="financials" class="section">
    <div class="section-title">Proyecci√≥n Financiera</div>
    <div class="section-desc">Datos anuales completos 2026‚Äì2035 ¬∑ Todos los valores en ‚Ç¨</div>

    <!-- PANEL DE CORRECCI√ìN DE GASTOS -->
    <div class="cost-correction-panel">
      <div class="correction-panel-title">
        üí∏ Correcci√≥n Manual de Costes Reales
        <span class="mode-badge original" id="costModeBadge">Modelo Original</span>
      </div>
      <div class="correction-panel-desc">
        Introduce los costes reales o revisados por a√±o y categor√≠a. El modelo recalcular√° autom√°ticamente el EBITDA y los m√°rgenes. Los campos vac√≠os mantienen la proyecci√≥n original.
      </div>

      <!-- Category selector -->
      <div class="cost-category-selector">
        <span class="cost-cat-label">Ver:</span>
        <button class="cost-cat-btn active" onclick="setCostCategory('total', this)">üìä Coste Total</button>
        <button class="cost-cat-btn" onclick="setCostCategory('personal', this)">üë§ Personal</button>
        <button class="cost-cat-btn" onclick="setCostCategory('tech', this)">üíª Tecnolog√≠a</button>
        <button class="cost-cat-btn" onclick="setCostCategory('marketing', this)">üì£ Marketing</button>
        <button class="cost-cat-btn" onclick="setCostCategory('ops', this)">‚öôÔ∏è Operaciones</button>
      </div>

      <div class="cost-correction-grid" id="costCorrectionGrid"></div>

      <div class="correction-actions">
        <button class="btn-calc" style="background:linear-gradient(135deg,var(--orange) 0%,#EA580C 100%);" onclick="applyCostCorrections()">‚ö° Aplicar y Recalcular</button>
        <button class="btn-secondary" onclick="resetCostCorrections()">‚Ü∫ Restaurar Original</button>
        <span style="font-size:12px;color:var(--gray-500);margin-left:4px;">Campos vac√≠os usan proyecci√≥n original</span>
      </div>

      <!-- Impact banner -->
      <div class="impact-banner" id="costImpactBanner">
        <div class="impact-item">
          <div class="il">Costes Ajustados 2035</div>
          <div class="iv" id="costImpCosts">‚Äî</div>
          <div class="id" id="costImpCostsDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">EBITDA Ajustado 2035</div>
          <div class="iv" id="costImpEbitda">‚Äî</div>
          <div class="id" id="costImpEbitdaDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">Margen Ajustado 2035</div>
          <div class="iv" id="costImpMargin">‚Äî</div>
          <div class="id" id="costImpMarginDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">A√±os Corregidos</div>
          <div class="iv" id="costImpCount">‚Äî</div>
          <div class="id" id="costImpCountLabel">correcciones activas</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:24px;">
      <div class="card-header">
        <div class="card-title">Ingresos por Categor√≠a</div>
        <span class="tag teal">Apilado</span>
      </div>
      <div class="chart-container tall">
        <canvas id="chartRevBreakdown"></canvas>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Costes vs Ingresos</div>
        </div>
        <div class="chart-container">
          <canvas id="chartCostes"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">EBITDA Acumulado</div>
        </div>
        <div class="chart-container">
          <canvas id="chartEbitdaAcum"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Tabla Financiera Completa</div>
        <span class="tag blue">2026‚Äì2035</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Usuarios</th>
              <th>Ingresos Suscripci√≥n</th>
              <th>Ingresos Transacciones</th>
              <th>Ingresos FX/Cripto</th>
              <th>Ingresos Tarjetas</th>
              <th>Total Ingresos</th>
              <th>Costes Totales</th>
              <th>EBITDA</th>
              <th>Margen %</th>
            </tr>
          </thead>
          <tbody id="finTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TABLA MODELO COSTES AJUSTADO -->
    <div class="card" id="costAdjustedCard" style="display:none; margin-top:20px;">
      <div class="card-header">
        <div class="card-title">üìä P&L Ajustado vs Proyecci√≥n Original</div>
        <span class="mode-badge cost-adjusted">Costes Ajustados</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Ingresos</th>
              <th>Costes Originales</th>
              <th>Costes Ajustados</th>
              <th>Œî Costes</th>
              <th>EBITDA Original</th>
              <th>EBITDA Ajustado</th>
              <th>Œî EBITDA</th>
              <th>Margen Ajustado</th>
            </tr>
          </thead>
          <tbody id="costAdjustedTable"></tbody>
        </table>
      </div>
    </div>

    <!-- GR√ÅFICO COMPARATIVO COSTES -->
    <div class="card" id="costAdjustedChartCard" style="display:none; margin-top:20px;">
      <div class="card-header">
        <div class="card-title">üìà EBITDA: Proyecci√≥n Original vs Ajustado por Costes</div>
        <span class="tag orange">Comparativa</span>
      </div>
      <div class="chart-container tall">
        <canvas id="chartCostAdjusted"></canvas>
      </div>
    </div>
  </section>

  <!-- ========= USERS ========= -->
  <section id="users" class="section">
    <div class="section-title">An√°lisis de Usuarios</div>
    <div class="section-desc">Cohortes, churn, retenci√≥n y distribuci√≥n por tier ¬∑ 2026‚Äì2035</div>

    <!-- PANEL DE CORRECCI√ìN -->
    <div class="correction-panel">
      <div class="correction-panel-title">
        üéõÔ∏è Correcci√≥n Manual de Usuarios Reales
        <span class="mode-badge original" id="modeBadge">Modelo Original</span>
      </div>
      <div class="correction-panel-desc">
        Introduce los usuarios reales observados para cada a√±o. El modelo recalcular√° autom√°ticamente ingresos, costes y EBITDA en funci√≥n de las desviaciones respecto a la proyecci√≥n original.
      </div>
      <div class="correction-grid" id="correctionGrid"></div>
      <div class="correction-actions">
        <button class="btn-calc" onclick="applyCorrections()">‚ö° Aplicar y Recalcular Modelo</button>
        <button class="btn-secondary" onclick="resetCorrections()">‚Ü∫ Restaurar Original</button>
        <span style="font-size:12px;color:var(--gray-500);margin-left:4px;">Campos vac√≠os usan proyecci√≥n original</span>
      </div>
      <div class="impact-banner" id="impactBanner">
        <div class="impact-item">
          <div class="il">Usuarios Ajustados 2035</div>
          <div class="iv" id="impUsers">‚Äî</div>
          <div class="id" id="impUsersDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">Ingresos Ajustados 2035</div>
          <div class="iv" id="impRev">‚Äî</div>
          <div class="id" id="impRevDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">EBITDA Ajustado 2035</div>
          <div class="iv" id="impEbitda">‚Äî</div>
          <div class="id" id="impEbitdaDelta">vs. proyecci√≥n</div>
        </div>
        <div class="impact-item">
          <div class="il">Desviaci√≥n Media</div>
          <div class="iv" id="impDeviation">‚Äî</div>
          <div class="id" id="impDeviationLabel">sobre el total</div>
        </div>
      </div>
    </div>

    <div class="grid-4">
      <div class="kpi-card teal">
        <div class="kpi-icon teal">üîÑ</div>
        <div class="kpi-label">Churn Anual</div>
        <div class="kpi-value">18%</div>
        <div class="kpi-delta">Tasa actual</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-icon blue">üì•</div>
        <div class="kpi-label">CAC Medio</div>
        <div class="kpi-value">‚Ç¨19.5</div>
        <div class="kpi-delta">Coste adquisici√≥n</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-icon green">üíé</div>
        <div class="kpi-label">LTV Medio</div>
        <div class="kpi-value">‚Ç¨140</div>
        <div class="kpi-delta">Valor de vida</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon orange">‚≠ê</div>
        <div class="kpi-label">Ratio LTV/CAC</div>
        <div class="kpi-value">7.18x</div>
        <div class="kpi-delta up">‚ñ≤ Excelente</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Nuevos Usuarios vs Churn</div>
        </div>
        <div class="chart-container">
          <canvas id="chartChurn"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Retenci√≥n de Cohortes</div>
        </div>
        <div class="chart-container">
          <canvas id="chartCohort"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Heatmap de Retenci√≥n por Cohorte</div>
        <span class="tag teal">2026‚Äì2035</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cohorte</th>
              <th>Usuarios Iniciales</th>
              <th>A√±o +1</th>
              <th>Retenci√≥n +1</th>
              <th>A√±o +2</th>
              <th>Retenci√≥n +2</th>
              <th>A√±o +3</th>
              <th>Retenci√≥n +3</th>
            </tr>
          </thead>
          <tbody id="cohortTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TABLA MODELO AJUSTADO -->
    <div class="card" id="adjustedModelCard" style="display:none;">
      <div class="card-header">
        <div class="card-title">üìä Modelo Ajustado vs Proyecci√≥n Original</div>
        <span class="mode-badge adjusted">Ajustado</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Usuarios Original</th>
              <th>Usuarios Reales</th>
              <th>Desviaci√≥n</th>
              <th>Ingresos Ajustados</th>
              <th>Costes Ajustados</th>
              <th>EBITDA Ajustado</th>
              <th>Margen %</th>
            </tr>
          </thead>
          <tbody id="adjustedTable"></tbody>
        </table>
      </div>
    </div>

    <!-- GR√ÅFICO COMPARATIVO AJUSTADO -->
    <div class="card" id="adjustedChartCard" style="display:none; margin-top:20px;">
      <div class="card-header">
        <div class="card-title">üìà Usuarios: Proyecci√≥n vs Realidad</div>
        <span class="tag orange">Comparativa</span>
      </div>
      <div class="chart-container tall">
        <canvas id="chartAdjustedUsers"></canvas>
      </div>
    </div>
  </section>

  <!-- ========= SIMULATOR ========= -->
  <section id="simulator" class="section">
    <div class="section-title">Simulador Personal 10 A√±os</div>
    <div class="section-desc">Introduce tus datos financieros y simula tu evoluci√≥n patrimonial en 10 a√±os</div>

    <div class="sim-section">
      <div class="sim-title">üíº Datos de Partida</div>
      <div class="sim-desc">Introduce ingresos, gastos y configuraci√≥n de inversi√≥n. El modelo recalcula autom√°ticamente.</div>

      <div class="form-grid">
        <div class="form-group">
          <label>üí∞ Ingresos Mensuales Netos (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="ingresos" value="2500" min="0" step="100" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üõí Gastos Mensuales Fijos (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="gastos" value="1800" min="0" step="100" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üè¶ Saldo Inicial (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="saldoInicial" value="5000" min="0" step="500" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üìà % Inversi√≥n Mensual del Ahorro</label>
          <div class="input-prefix">
            <span>%</span>
            <input type="number" id="pctInversion" value="50" min="0" max="100" step="5" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üìä Rentabilidad Inversi√≥n Anual (%)</label>
          <div class="input-prefix">
            <span>%</span>
            <input type="number" id="rentInversion" value="7" min="0" max="30" step="0.5" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üìâ Inflaci√≥n Estimada Anual (%)</label>
          <div class="input-prefix">
            <span>%</span>
            <input type="number" id="inflacion" value="3" min="0" max="15" step="0.5" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üöÄ Crecimiento Ingresos Anual (%)</label>
          <div class="input-prefix">
            <span>%</span>
            <input type="number" id="crIngresos" value="5" min="0" max="50" step="1" oninput="calcSimulator()">
          </div>
        </div>
        <div class="form-group">
          <label>üìÜ Horizonte (a√±os)</label>
          <input type="number" id="horizon" value="10" min="5" max="30" step="1" oninput="calcSimulator()">
        </div>
        <div class="form-group">
          <label>üí∏ Gastos Extraordinarios/A√±o (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="gastosExtra" value="2000" min="0" step="500" oninput="calcSimulator()">
          </div>
        </div>
      </div>

      <div class="result-box" id="simResults">
        <div class="result-item">
          <div class="rl">Ahorro Mensual</div>
          <div class="rv" id="resMensual">‚Äî</div>
        </div>
        <div class="result-item highlight-green">
          <div class="rl">Patrimonio Final</div>
          <div class="rv" id="resPatrimonio">‚Äî</div>
        </div>
        <div class="result-item">
          <div class="rl">Cartera Inversi√≥n</div>
          <div class="rv" id="resInversion">‚Äî</div>
        </div>
        <div class="result-item">
          <div class="rl">Saldo L√≠quido</div>
          <div class="rv" id="resSaldo">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-bottom:24px;">
      <div class="card-header">
        <div class="card-title">Evoluci√≥n Patrimonial</div>
        <span class="tag teal">Proyecci√≥n personal</span>
      </div>
      <div class="chart-container tall">
        <canvas id="chartSim"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Tabla Anual Detallada</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Ingresos Anuales</th>
              <th>Gastos Anuales</th>
              <th>Ahorro Bruto</th>
              <th>Invertido</th>
              <th>Cartera Inversi√≥n</th>
              <th>Saldo Liquidez</th>
              <th>Patrimonio Total</th>
            </tr>
          </thead>
          <tbody id="simTable"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========= TAXES ========= -->
  <section id="taxes" class="section">
    <div class="section-title">Calculadora Impuestos Espa√±a</div>
    <div class="section-desc">Calcula tus obligaciones fiscales trimestrales ¬∑ Aut√≥nomos y empresas</div>

    <div class="sim-section">
      <div class="sim-title">üèõÔ∏è Configuraci√≥n Fiscal</div>
      <div class="sim-desc">Introduce tus datos fiscales para calcular los pagos trimestrales a Hacienda</div>

      <div class="form-grid">
        <div class="form-group">
          <label>üíº Tipo de Actividad</label>
          <select id="tipoActividad" onchange="calcTaxes()">
            <option value="autonomo">Aut√≥nomo / Profesional</option>
            <option value="empresa">Sociedad Limitada</option>
            <option value="startup">Startup (IS reducido)</option>
          </select>
        </div>
        <div class="form-group">
          <label>üí∞ Ingresos Brutos Anuales (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="ingBrutos" value="80000" min="0" step="1000" oninput="calcTaxes()">
          </div>
        </div>
        <div class="form-group">
          <label>üßæ Gastos Deducibles Anuales (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="gastosDed" value="25000" min="0" step="500" oninput="calcTaxes()">
          </div>
        </div>
        <div class="form-group">
          <label>üìã IVA Repercutido Anual (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="ivaRep" value="16800" min="0" step="100" oninput="calcTaxes()">
          </div>
        </div>
        <div class="form-group">
          <label>üîª IVA Soportado Anual (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="ivaSop" value="4200" min="0" step="100" oninput="calcTaxes()">
          </div>
        </div>
        <div class="form-group">
          <label>üè• Cuota Seguridad Social Mensual (‚Ç¨)</label>
          <div class="input-prefix">
            <span>‚Ç¨</span>
            <input type="number" id="cuotaSS" value="294" min="0" step="10" oninput="calcTaxes()">
          </div>
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:24px;">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Resumen Fiscal Anual</div>
        </div>
        <div id="taxSummary"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Distribuci√≥n de Carga Fiscal</div>
        </div>
        <div class="chart-container short">
          <canvas id="chartTax"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Calendario de Pagos Trimestrales</div>
        <span class="tag blue">2026</span>
      </div>
      <div class="tax-table" id="taxCalendar"></div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="card-header">
        <div class="card-title">Tramos IRPF 2024 (Aut√≥nomos)</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Tramo</th>
              <th>Base Imponible</th>
              <th>Tipo</th>
              <th>Cuota M√°xima Tramo</th>
            </tr>
          </thead>
          <tbody>
            <tr><td>1</td><td>Hasta ‚Ç¨12.450</td><td class="tag teal">19%</td><td>‚Ç¨2.365,50</td></tr>
            <tr><td>2</td><td>‚Ç¨12.450 ‚Äì ‚Ç¨20.200</td><td class="tag blue">24%</td><td>‚Ç¨1.860,00</td></tr>
            <tr><td>3</td><td>‚Ç¨20.200 ‚Äì ‚Ç¨35.200</td><td class="tag blue">30%</td><td>‚Ç¨4.500,00</td></tr>
            <tr><td>4</td><td>‚Ç¨35.200 ‚Äì ‚Ç¨60.000</td><td class="tag orange">37%</td><td>‚Ç¨9.176,00</td></tr>
            <tr><td>5</td><td>‚Ç¨60.000 ‚Äì ‚Ç¨300.000</td><td class="tag orange">45%</td><td>‚Ç¨108.000,00</td></tr>
            <tr><td>6</td><td>M√°s de ‚Ç¨300.000</td><td style="color:var(--red);font-weight:700;">47%</td><td>Sin l√≠mite</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========= KPIs ========= -->
  <section id="kpis" class="section">
    <div class="section-title">KPIs Estrat√©gicos</div>
    <div class="section-desc">Indicadores clave de rendimiento y m√©tricas de negocio</div>

    <div class="grid-4">
      <div class="kpi-card teal">
        <div class="kpi-icon teal">üéØ</div>
        <div class="kpi-label">CAC</div>
        <div class="kpi-value">‚Ç¨19.5</div>
        <div class="kpi-delta">Coste adq. cliente</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-icon blue">üíé</div>
        <div class="kpi-label">LTV</div>
        <div class="kpi-value">‚Ç¨140</div>
        <div class="kpi-delta">Valor de vida</div>
      </div>
      <div class="kpi-card green">
        <div class="kpi-icon green">üìä</div>
        <div class="kpi-label">LTV/CAC</div>
        <div class="kpi-value">7.18x</div>
        <div class="kpi-delta up">‚ñ≤ Benchmark: >3x</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon orange">üîÑ</div>
        <div class="kpi-label">Churn Anual</div>
        <div class="kpi-value">18%</div>
        <div class="kpi-delta">Mejora target: 12%</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Benchmarks del Sector</div>
        </div>
        <div style="padding:8px 0;">
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="font-size:13px;font-weight:600;">LTV/CAC (7.18x)</span>
              <span class="tag teal">Excelente (>3x)</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:89%;background:linear-gradient(90deg,var(--teal),var(--teal-mid));"></div></div>
          </div>
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="font-size:13px;font-weight:600;">Churn (18%)</span>
              <span class="tag orange">Mejorable (target &lt;15%)</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:60%;background:linear-gradient(90deg,var(--orange),#FBBF24);"></div></div>
          </div>
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="font-size:13px;font-weight:600;">Margen EBITDA (73.7%)</span>
              <span class="tag teal">World-class (&gt;40%)</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:94%;"></div></div>
          </div>
          <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span style="font-size:13px;font-weight:600;">Mix Premium (30%)</span>
              <span class="tag blue">Sano (target 35%)</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:75%;background:linear-gradient(90deg,var(--blue),var(--indigo));"></div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Evoluci√≥n Margen Neto</div>
        </div>
        <div class="chart-container">
          <canvas id="chartKpiMargen"></canvas>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">Tabla KPIs Clave por A√±o</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Usuarios Activos</th>
              <th>% Premium</th>
              <th>Ingresos/Usuario</th>
              <th>EBITDA/Usuario</th>
              <th>Coste/Usuario</th>
              <th>Margen EBITDA</th>
              <th>Crecimiento YoY</th>
            </tr>
          </thead>
          <tbody id="kpiTable"></tbody>
        </table>
      </div>
    </div>
  </section>

</main>

<footer>
  <strong>FinX</strong> ‚Äî Neobanco Digital GenZ ¬∑ Modelo de Proyecci√≥n 2026‚Äì2035 ¬∑ Dashboard interno ¬∑ Mockup Conceptual
</footer>

<!-- ===== DOWNLOAD BAR ===== -->
<div class="download-bar">
  <div class="download-bar-label">üì• Exportar datos</div>
  <button class="btn-download excel" onclick="downloadExcel()">
    <span class="dl-icon">üìó</span> Descargar Excel
  </button>
  <button class="btn-download csv" onclick="downloadCSV()">
    <span class="dl-icon">üìÑ</span> Descargar CSV
  </button>
</div>

<script>
// ===== DATA =====
const data = [
  { year: 2026, users: 564000, newUsers: 564000, churn: 0, starter: 394800, premium: 169200, revSub: 12182400, revTx: 20304000, revFx: 4512000, revCard: 1015200, revTotal: 38013600, costs: 10003400, ebitda: 28010200 },
  { year: 2027, users: 1026480, newUsers: 564000, churn: 101520, starter: 718536, premium: 307944, revSub: 22171968, revTx: 36953280, revFx: 8211840, revCard: 1847664, revTotal: 69184752, costs: 17796188, ebitda: 51388564 },
  { year: 2028, users: 1507233, newUsers: 665520, churn: 184766, starter: 1055063, premium: 452170, revSub: 32556246, revTx: 54260410, revFx: 12057869, revCard: 2713020, revTotal: 101587545, costs: 25896886, ebitda: 75690658 },
  { year: 2029, users: 1984697, newUsers: 748766, churn: 271302, starter: 1389288, premium: 595409, revSub: 42869476, revTx: 71449126, revFx: 15877584, revCard: 3572456, revTotal: 133768642, costs: 33942160, ebitda: 99826481 },
  { year: 2030, users: 2462754, newUsers: 835302, churn: 357245, starter: 1723928, premium: 738826, revSub: 53195494, revTx: 88659157, revFx: 19702035, revCard: 4432958, revTotal: 165989644, costs: 41997411, ebitda: 123992233 },
  { year: 2031, users: 2940704, newUsers: 921245, churn: 443295, starter: 2058492, premium: 882211, revSub: 63519211, revTx: 105865352, revFx: 23525634, revCard: 5293268, revTotal: 198203464, costs: 50050866, ebitda: 148152598 },
  { year: 2032, users: 3418673, newUsers: 1007295, churn: 529326, starter: 2393071, premium: 1025601, revSub: 73843342, revTx: 123072237, revFx: 27349386, revCard: 6153612, revTotal: 230418576, costs: 58104644, ebitda: 172313932 },
  { year: 2033, users: 3896638, newUsers: 1093326, churn: 615361, starter: 2727647, premium: 1168991, revSub: 84167398, revTx: 140278997, revFx: 31173111, revCard: 7013950, revTotal: 262633456, costs: 66158364, ebitda: 196475092 },
  { year: 2034, users: 4374605, newUsers: 1179361, churn: 701394, starter: 3062223, premium: 1312381, revSub: 94491468, revTx: 157485780, revFx: 34996840, revCard: 7874289, revTotal: 294848378, costs: 74212094, ebitda: 220636283 },
  { year: 2035, users: 4852571, newUsers: 1265394, churn: 787428, starter: 3396799, premium: 1455771, revSub: 104815536, revTx: 174692560, revFx: 38820569, revCard: 8734628, revTotal: 327063292, costs: 82265823, ebitda: 244797469 }
];

const cohortes = [
  { year: 2026, init: 169200, y1: 138744, y2: 113770, y3: 93291 },
  { year: 2027, init: 338400, y1: 277488, y2: 227540, y3: 186582 },
  { year: 2028, init: 507600, y1: 416232, y2: 341310, y3: 279874 },
  { year: 2029, init: 676800, y1: 554976, y2: 455080, y3: 373165 },
  { year: 2030, init: 846000, y1: 694320, y2: 569850, y3: 467457 },
  { year: 2031, init: 1015200, y1: 832464, y2: 682619, y3: 560148 },
  { year: 2032, init: 1184400, y1: 970608, y2: 796389, y3: 652839 },
  { year: 2033, init: 1353600, y1: 1109952, y2: 910158, y3: 745730 },
  { year: 2034, init: 1522800, y1: 1249296, y2: 1024928, y3: 838421 },
  { year: 2035, init: 1692000, y1: 1387440, y2: 1138697, y3: 933211 }
];

const years = data.map(d => d.year);
const fmt = n => '‚Ç¨' + (Math.abs(n) >= 1e6 ? (n/1e6).toFixed(1)+'M' : Math.abs(n) >= 1e3 ? (n/1e3).toFixed(0)+'K' : n.toFixed(0));
const fmtFull = n => {
  const abs = Math.abs(n);
  const formatted = abs.toLocaleString('es-ES', {maximumFractionDigits:0});
  return (n < 0 ? '-‚Ç¨' : '‚Ç¨') + formatted;
};
const pct = (a,b) => ((a/b)*100).toFixed(1)+'%';

const COLORS = {
  teal: '#0DBFAD', blue: '#2563EB', orange: '#F97316',
  green: '#16A34A', indigo: '#4F46E5', red: '#DC2626',
  tealLight: 'rgba(13,191,173,0.15)', blueLight: 'rgba(37,99,235,0.15)'
};

const CHART_DEFAULTS = {
  plugins: { legend: { labels: { font: { family: 'DM Sans', size: 12 }, boxWidth: 12 } } },
  scales: {
    x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Sans', size: 11 } } },
    y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { family: 'DM Sans', size: 11 } } }
  }
};

function makeChart(id, config) {
  const ctx = document.getElementById(id);
  if (!ctx) return;
  if (ctx._chart) ctx._chart.destroy();
  const c = new Chart(ctx, config);
  ctx._chart = c;
  return c;
}

// ===== CHARTS =====
// Returns adjustedData if user corrections are active, otherwise originalData
function getActiveData() {
  return (typeof adjustedData !== 'undefined' && adjustedData.some(d => d._overridden))
    ? adjustedData : originalData;
}

// Track which tabs have been initialized
const tabInited = {};

function initChartsForTab(tabId) {
  if (tabInited[tabId]) return;
  tabInited[tabId] = true;

  if (tabId === 'overview') initOverviewCharts();
  if (tabId === 'financials') initFinancialsCharts();
  if (tabId === 'users') initUsersCharts();
  if (tabId === 'kpis') initKpiCharts();
}

function initOverviewCharts() {
  const src = getActiveData();
  const last = src[src.length - 1];

  // Rev vs EBITDA
  makeChart('chartRevEbitda', {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'Ingresos Totales', data: src.map(d=>d.revTotal/1e6), backgroundColor: 'rgba(37,99,235,0.75)', borderRadius: 4 },
        { label: 'EBITDA',           data: src.map(d=>d.ebitda/1e6),   backgroundColor: 'rgba(13,191,173,0.85)', borderRadius: 4 },
        { label: 'Costes',           data: src.map(d=>d.costs/1e6),    backgroundColor: 'rgba(249,115,22,0.7)',  borderRadius: 4 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      plugins: { ...CHART_DEFAULTS.plugins, tooltip: { callbacks: { label: c => c.dataset.label+': ‚Ç¨'+c.raw.toFixed(1)+'M' } } },
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => '‚Ç¨'+v+'M', font: {family:'DM Sans',size:11} } } }
    }
  });

  // Users
  makeChart('chartUsers', {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: 'Usuarios Activos', data: src.map(d=>d.users/1e6),   borderColor: COLORS.teal, backgroundColor: COLORS.tealLight, fill: true, tension: 0.4, borderWidth: 2.5, pointBackgroundColor: COLORS.teal, pointRadius: 4 },
        { label: 'Premium',          data: src.map(d=>d.premium/1e6), borderColor: COLORS.blue, backgroundColor: COLORS.blueLight, fill: true, tension: 0.4, borderWidth: 2,   pointBackgroundColor: COLORS.blue, pointRadius: 3 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => v.toFixed(1)+'M', font: {family:'DM Sans',size:11} } } }
    }
  });

  // Mix 2035 Donut
  makeChart('chartMix', {
    type: 'doughnut',
    data: {
      labels: ['Suscripci√≥n', 'Transacciones', 'FX/Cripto', 'Tarjetas'],
      datasets: [{ data: [last.revSub/1e6, last.revTx/1e6, last.revFx/1e6, last.revCard/1e6], backgroundColor: [COLORS.teal, COLORS.blue, COLORS.orange, COLORS.indigo], borderWidth: 2, borderColor: '#fff' }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family:'DM Sans', size:11 }, boxWidth: 10 } }, tooltip: { callbacks: { label: c => c.label+': ‚Ç¨'+c.raw.toFixed(1)+'M' } } }, cutout: '65%' }
  });

  // Starter vs Premium
  makeChart('chartTiers', {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'Starter', data: src.map(d=>d.starter/1e6), backgroundColor: 'rgba(13,191,173,0.75)', borderRadius: 4 },
        { label: 'Premium', data: src.map(d=>d.premium/1e6), backgroundColor: 'rgba(37,99,235,0.8)',   borderRadius: 4 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: { ...CHART_DEFAULTS.scales.x, stacked: true }, y: { ...CHART_DEFAULTS.scales.y, stacked: true, ticks: { callback: v => v.toFixed(1)+'M', font:{family:'DM Sans',size:11} } } }
    }
  });

  // Margin %
  makeChart('chartMargin', {
    type: 'line',
    data: {
      labels: years,
      datasets: [{ label: 'Margen EBITDA %', data: src.map(d=>+((d.ebitda/d.revTotal)*100).toFixed(1)), borderColor: COLORS.orange, backgroundColor: 'rgba(249,115,22,0.1)', fill: true, tension: 0.4, borderWidth: 2.5, pointBackgroundColor: COLORS.orange, pointRadius: 4 }]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, min: 60, ticks: { callback: v => v+'%', font:{family:'DM Sans',size:11} } } }
    }
  });
}

function initFinancialsCharts() {
  // Rev Breakdown stacked
  makeChart('chartRevBreakdown', {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'Suscripci√≥n', data: data.map(d=>d.revSub/1e6), backgroundColor: COLORS.teal, borderRadius: 4 },
        { label: 'Transacciones', data: data.map(d=>d.revTx/1e6), backgroundColor: COLORS.blue, borderRadius: 4 },
        { label: 'FX/Cripto', data: data.map(d=>d.revFx/1e6), backgroundColor: COLORS.orange, borderRadius: 4 },
        { label: 'Tarjetas', data: data.map(d=>d.revCard/1e6), backgroundColor: COLORS.indigo, borderRadius: 4 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: { ...CHART_DEFAULTS.scales.x, stacked: true }, y: { ...CHART_DEFAULTS.scales.y, stacked: true, ticks: { callback: v => '‚Ç¨'+v+'M', font:{family:'DM Sans',size:11} } } }
    }
  });

  // Costes vs Rev
  makeChart('chartCostes', {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: 'Ingresos', data: data.map(d=>d.revTotal/1e6), borderColor: COLORS.blue, tension: 0.4, borderWidth: 2, pointRadius: 3 },
        { label: 'Costes', data: data.map(d=>d.costs/1e6), borderColor: COLORS.red, tension: 0.4, borderWidth: 2, pointRadius: 3 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => '‚Ç¨'+v+'M', font:{family:'DM Sans',size:11} } } }
    }
  });

  // EBITDA Acumulado
  let acum = 0;
  const acumData = data.map(d => { acum += d.ebitda; return acum/1e6; });
  makeChart('chartEbitdaAcum', {
    type: 'line',
    data: { labels: years, datasets: [{ label: 'EBITDA Acumulado', data: acumData, borderColor: COLORS.green, backgroundColor: 'rgba(22,163,74,0.1)', fill: true, tension: 0.4, borderWidth: 2.5, pointBackgroundColor: COLORS.green, pointRadius: 4 }] },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => '‚Ç¨'+v.toFixed(0)+'M', font:{family:'DM Sans',size:11} } } }
    }
  });
}

function initUsersCharts() {
  // Users Churn
  makeChart('chartChurn', {
    type: 'bar',
    data: {
      labels: years,
      datasets: [
        { label: 'Nuevos Usuarios', data: data.map(d=>d.newUsers/1e3), backgroundColor: 'rgba(13,191,173,0.8)', borderRadius: 4 },
        { label: 'Churn', data: data.map(d=>d.churn/1e3), backgroundColor: 'rgba(220,38,38,0.7)', borderRadius: 4 }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => v+'K', font:{family:'DM Sans',size:11} } } }
    }
  });

  // Cohort retention
  makeChart('chartCohort', {
    type: 'line',
    data: {
      labels: ['Inicio', 'A√±o +1', 'A√±o +2', 'A√±o +3'],
      datasets: cohortes.slice(0,5).map((c, i) => ({
        label: 'Cohorte '+c.year,
        data: [100, +(c.y1/c.init*100).toFixed(1), +(c.y2/c.init*100).toFixed(1), +(c.y3/c.init*100).toFixed(1)],
        borderColor: [COLORS.teal, COLORS.blue, COLORS.orange, COLORS.indigo, COLORS.green][i],
        tension: 0.4, borderWidth: 2, pointRadius: 3, fill: false
      }))
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, min: 0, max: 100, ticks: { callback: v => v+'%', font:{family:'DM Sans',size:11} } } }
    }
  });
}

function initKpiCharts() {
  // KPI margin
  makeChart('chartKpiMargen', {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: 'Margen EBITDA %', data: data.map(d=>+((d.ebitda/d.revTotal)*100).toFixed(1)), borderColor: COLORS.teal, tension: 0.4, borderWidth: 2.5, pointRadius: 4, fill: false },
        { label: 'Ingreso/Usuario (‚Ç¨)', data: data.map(d=>+(d.revTotal/d.users).toFixed(1)), borderColor: COLORS.orange, tension: 0.4, borderWidth: 2, pointRadius: 3, fill: false }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { font:{family:'DM Sans',size:11} } } }
    }
  });
}

// ===== CORRECTION PANEL =====
const originalData = JSON.parse(JSON.stringify(data)); // deep copy of original
let adjustedData = JSON.parse(JSON.stringify(data));   // working copy

function buildCorrectionGrid() {
  const grid = document.getElementById('correctionGrid');
  grid.innerHTML = '';
  originalData.forEach((d, i) => {
    grid.innerHTML += `
      <div class="correction-field">
        <div class="year-tag">${d.year}</div>
        <label>Usuarios Reales</label>
        <div class="correction-input-wrap">
          <input
            type="number"
            id="corr_${d.year}"
            placeholder="${(d.users/1e3).toFixed(0)}K (proyectado)"
            min="0"
            step="1000"
            oninput="onCorrectionInput(${d.year}, this)"
          >
          <button class="reset-btn" title="Restaurar a√±o" onclick="resetYear(${d.year})">‚úï</button>
        </div>
        <span class="deviation-chip neutral" id="chip_${d.year}">Proyecci√≥n</span>
      </div>`;
  });
}

function onCorrectionInput(year, inputEl) {
  const val = inputEl.value.trim();
  const orig = originalData.find(d => d.year === year).users;
  const chip = document.getElementById(`chip_${year}`);
  if (val === '' || isNaN(parseFloat(val))) {
    inputEl.classList.remove('has-override');
    chip.className = 'deviation-chip neutral';
    chip.textContent = 'Proyecci√≥n';
  } else {
    const real = parseFloat(val);
    const dev = ((real - orig) / orig * 100);
    inputEl.classList.add('has-override');
    chip.className = 'deviation-chip ' + (dev >= 0 ? 'positive' : 'negative');
    chip.textContent = (dev >= 0 ? '‚ñ≤ +' : '‚ñº ') + dev.toFixed(1) + '%';
  }
}

function resetYear(year) {
  const inp = document.getElementById(`corr_${year}`);
  inp.value = '';
  inp.classList.remove('has-override');
  const chip = document.getElementById(`chip_${year}`);
  chip.className = 'deviation-chip neutral';
  chip.textContent = 'Proyecci√≥n';
}

function applyCorrections() {
  // Recalculate model based on user overrides
  // Revenue per user and cost per user ratios from original data
  adjustedData = originalData.map((orig, i) => {
    const inp = document.getElementById(`corr_${orig.year}`);
    const val = inp ? inp.value.trim() : '';
    const hasOverride = val !== '' && !isNaN(parseFloat(val));
    const realUsers = hasOverride ? Math.round(parseFloat(val)) : orig.users;
    const ratio = realUsers / orig.users; // scaling factor

    // Scale revenues and costs proportionally to user change
    return {
      ...orig,
      users: realUsers,
      starter: Math.round(orig.starter * ratio),
      premium: Math.round(orig.premium * ratio),
      revSub: orig.revSub * ratio,
      revTx: orig.revTx * ratio,
      revFx: orig.revFx * ratio,
      revCard: orig.revCard * ratio,
      revTotal: orig.revTotal * ratio,
      costs: orig.costs * ratio,
      ebitda: orig.ebitda * ratio,
      _overridden: hasOverride,
      _ratio: ratio
    };
  });

  // Update charts that depend on user data
  refreshAdjustedCharts();
  refreshOverview(adjustedData);
  showAdjustedTable();
  updateImpactBanner();

  // Update mode badge
  const hasAny = adjustedData.some(d => d._overridden);
  const badge = document.getElementById('modeBadge');
  badge.className = hasAny ? 'mode-badge adjusted' : 'mode-badge original';
  badge.textContent = hasAny ? 'Modelo Ajustado' : 'Modelo Original';
}

function resetCorrections() {
  adjustedData = JSON.parse(JSON.stringify(originalData));
  originalData.forEach(d => resetYear(d.year));
  refreshAdjustedCharts();
  refreshOverview(originalData);
  document.getElementById('adjustedModelCard').style.display = 'none';
  document.getElementById('adjustedChartCard').style.display = 'none';
  document.getElementById('modeBadge').className = 'mode-badge original';
  document.getElementById('modeBadge').textContent = 'Modelo Original';
  updateImpactBanner();
}

function updateImpactBanner() {
  const origLast = originalData[9];
  const adjLast = adjustedData[9];

  const userDelta = ((adjLast.users - origLast.users) / origLast.users * 100);
  const revDelta  = ((adjLast.revTotal - origLast.revTotal) / origLast.revTotal * 100);
  const ebitdaDelta = ((adjLast.ebitda - origLast.ebitda) / origLast.ebitda * 100);

  const deviations = adjustedData
    .filter(d => d._overridden)
    .map(d => Math.abs(d._ratio - 1) * 100);
  const avgDev = deviations.length ? (deviations.reduce((a,b)=>a+b,0) / deviations.length) : 0;
  const overriddenCount = deviations.length;

  document.getElementById('impUsers').textContent = (adjLast.users/1e6).toFixed(2)+'M';
  document.getElementById('impUsersDelta').textContent =
    (userDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + userDelta.toFixed(1)+'% vs original';
  document.getElementById('impUsersDelta').className = 'id ' + (userDelta >= 0 ? 'up' : 'down');

  document.getElementById('impRev').textContent = fmt(adjLast.revTotal);
  document.getElementById('impRevDelta').textContent =
    (revDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + revDelta.toFixed(1)+'% vs original';
  document.getElementById('impRevDelta').className = 'id ' + (revDelta >= 0 ? 'up' : 'down');

  document.getElementById('impEbitda').textContent = fmt(adjLast.ebitda);
  document.getElementById('impEbitdaDelta').textContent =
    (ebitdaDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + ebitdaDelta.toFixed(1)+'% vs original';
  document.getElementById('impEbitdaDelta').className = 'id ' + (ebitdaDelta >= 0 ? 'up' : 'down');

  document.getElementById('impDeviation').textContent = overriddenCount ? avgDev.toFixed(1)+'%' : '‚Äî';
  document.getElementById('impDeviationLabel').textContent = overriddenCount
    ? `${overriddenCount} a√±o${overriddenCount>1?'s':''} corregido${overriddenCount>1?'s':''}`
    : 'Sin correcciones activas';
}

function showAdjustedTable() {
  const card = document.getElementById('adjustedModelCard');
  const chartCard = document.getElementById('adjustedChartCard');
  card.style.display = 'block';
  chartCard.style.display = 'block';

  const tbody = document.getElementById('adjustedTable');
  tbody.innerHTML = '';
  adjustedData.forEach((adj, i) => {
    const orig = originalData[i];
    const dev = ((adj.users - orig.users) / orig.users * 100);
    const margin = ((adj.ebitda / adj.revTotal) * 100).toFixed(1);
    const devClass = dev > 0 ? 'positive' : dev < 0 ? 'negative' : '';
    tbody.innerHTML += `<tr${adj._overridden ? ' style="background:var(--orange-light);"' : ''}>
      <td>${adj.year}${adj._overridden ? ' üî∂' : ''}</td>
      <td>${(orig.users/1e6).toFixed(2)}M</td>
      <td><strong>${(adj.users/1e6).toFixed(2)}M</strong></td>
      <td class="${devClass}">${dev >= 0 ? '+' : ''}${dev.toFixed(1)}%</td>
      <td>${fmt(adj.revTotal)}</td>
      <td>${fmt(adj.costs)}</td>
      <td class="positive">${fmt(adj.ebitda)}</td>
      <td>${margin}%</td>
    </tr>`;
  });
}

function refreshOverview(source) {
  const first = source[0];
  const last  = source[source.length - 1];
  const isAdj = source.some(d => d._overridden);

  // ‚îÄ‚îÄ Hero banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('heroUsers').textContent  = (last.users/1e6).toFixed(2) + 'M';
  document.getElementById('heroRev').textContent    = fmt(last.revTotal);
  document.getElementById('heroEbitda').textContent = fmt(last.ebitda);
  document.getElementById('heroMargin').textContent = ((last.ebitda/last.revTotal)*100).toFixed(1) + '%';
  document.getElementById('overviewAdjBadge').style.display = isAdj ? 'inline' : 'none';

  // ‚îÄ‚îÄ KPI cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const origFirst = originalData[0];
  const uDelta  = ((first.users    - origFirst.users)    / origFirst.users    * 100).toFixed(1);
  const rDelta  = ((first.revTotal - origFirst.revTotal) / origFirst.revTotal * 100).toFixed(1);
  const eDelta  = ((first.ebitda   - origFirst.ebitda)   / origFirst.ebitda   * 100).toFixed(1);

  document.getElementById('kpiUsers2026').textContent = first.users >= 1e6
    ? (first.users/1e6).toFixed(2)+'M' : Math.round(first.users/1e3)+'K';
  document.getElementById('kpiRev2026').textContent    = fmt(first.revTotal);
  document.getElementById('kpiEbitda2026').textContent = fmt(first.ebitda);

  if (isAdj) {
    document.getElementById('kpiUsers2026Delta').textContent  = (uDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + uDelta + '% vs proyecci√≥n';
    document.getElementById('kpiRev2026Delta').textContent    = (rDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + rDelta + '% vs proyecci√≥n';
    document.getElementById('kpiEbitda2026Delta').textContent = (eDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + eDelta + '% vs proyecci√≥n';
    document.getElementById('kpiUsers2026Delta').className  = 'kpi-delta ' + (uDelta >= 0 ? 'up' : 'down');
    document.getElementById('kpiRev2026Delta').className    = 'kpi-delta ' + (rDelta >= 0 ? 'up' : 'down');
    document.getElementById('kpiEbitda2026Delta').className = 'kpi-delta ' + (eDelta >= 0 ? 'up' : 'down');
  } else {
    document.getElementById('kpiUsers2026Delta').textContent  = '‚ñ≤ A√±o de lanzamiento';
    document.getElementById('kpiRev2026Delta').textContent    = '‚ñ≤ Base s√≥lida';
    document.getElementById('kpiEbitda2026Delta').textContent = '‚ñ≤ ' + ((origFirst.ebitda/origFirst.revTotal)*100).toFixed(1) + '% margen';
    document.getElementById('kpiUsers2026Delta').className  = 'kpi-delta up';
    document.getElementById('kpiRev2026Delta').className    = 'kpi-delta up';
    document.getElementById('kpiEbitda2026Delta').className = 'kpi-delta up';
  }

  // ‚îÄ‚îÄ Overview charts (only if already initialised) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (!tabInited['overview']) return; // will be built fresh when tab opens

  // chartRevEbitda ‚Äî bar: Ingresos / EBITDA / Costes
  const revChart = document.getElementById('chartRevEbitda');
  if (revChart && revChart._chart) {
    revChart._chart.data.datasets[0].data = source.map(d => d.revTotal/1e6);
    revChart._chart.data.datasets[1].data = source.map(d => d.ebitda/1e6);
    revChart._chart.data.datasets[2].data = source.map(d => d.costs/1e6);
    revChart._chart.update();
  }

  // chartUsers ‚Äî line: Activos / Premium
  const usersChart = document.getElementById('chartUsers');
  if (usersChart && usersChart._chart) {
    usersChart._chart.data.datasets[0].data = source.map(d => d.users/1e6);
    usersChart._chart.data.datasets[1].data = source.map(d => d.premium/1e6);
    usersChart._chart.update();
  }

  // chartMix ‚Äî doughnut 2035 revenue mix
  const mixChart = document.getElementById('chartMix');
  if (mixChart && mixChart._chart) {
    mixChart._chart.data.datasets[0].data = [
      last.revSub/1e6, last.revTx/1e6, last.revFx/1e6, last.revCard/1e6
    ];
    mixChart._chart.update();
  }

  // chartTiers ‚Äî bar: Starter / Premium
  const tiersChart = document.getElementById('chartTiers');
  if (tiersChart && tiersChart._chart) {
    tiersChart._chart.data.datasets[0].data = source.map(d => d.starter/1e6);
    tiersChart._chart.data.datasets[1].data = source.map(d => d.premium/1e6);
    tiersChart._chart.update();
  }

  // chartMargin ‚Äî line: Margen EBITDA %
  const marginChart = document.getElementById('chartMargin');
  if (marginChart && marginChart._chart) {
    marginChart._chart.data.datasets[0].data = source.map(d => +((d.ebitda/d.revTotal)*100).toFixed(1));
    marginChart._chart.update();
  }
}


function refreshAdjustedCharts() {
  // Ensure users tab charts exist
  if (!tabInited['users']) {
    initUsersCharts();
    tabInited['users'] = true;
  }

  // Refresh users chart with adjusted data
  const ctx = document.getElementById('chartUsers');
  if (ctx && ctx._chart) {
    ctx._chart.data.datasets[0].data = adjustedData.map(d=>d.users/1e6);
    ctx._chart.data.datasets[1].data = adjustedData.map(d=>d.premium/1e6);
    ctx._chart.update();
  }

  // Refresh churn chart
  const cCtx = document.getElementById('chartChurn');
  if (cCtx && cCtx._chart) {
    cCtx._chart.data.datasets[0].data = adjustedData.map(d=>d.newUsers/1e3);
    cCtx._chart.data.datasets[1].data = adjustedData.map(d=>d.churn/1e3);
    cCtx._chart.update();
  }

  // Build comparative adjusted vs original chart
  const aCtx = document.getElementById('chartAdjustedUsers');
  if (aCtx) {
    if (aCtx._chart) aCtx._chart.destroy();
    aCtx._chart = new Chart(aCtx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [
          {
            label: 'Proyecci√≥n Original',
            data: originalData.map(d=>d.users/1e6),
            borderColor: COLORS.blue,
            borderDash: [6, 3],
            tension: 0.4,
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: COLORS.blue,
            fill: false
          },
          {
            label: 'Usuarios Reales / Ajustados',
            data: adjustedData.map(d=>d.users/1e6),
            borderColor: COLORS.teal,
            backgroundColor: COLORS.tealLight,
            tension: 0.4,
            borderWidth: 2.5,
            pointRadius: adjustedData.map(d=> d._overridden ? 7 : 4),
            pointBackgroundColor: adjustedData.map(d=> d._overridden ? COLORS.orange : COLORS.teal),
            pointBorderColor: adjustedData.map(d=> d._overridden ? '#fff' : COLORS.teal),
            pointBorderWidth: 2,
            fill: true
          }
        ]
      },
      options: {
        ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
        plugins: {
          ...CHART_DEFAULTS.plugins,
          tooltip: { callbacks: {
            label: c => c.dataset.label + ': ' + c.raw.toFixed(2) + 'M usuarios'
          }}
        },
        scales: {
          x: CHART_DEFAULTS.scales.x,
          y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => v.toFixed(1)+'M', font:{family:'DM Sans',size:11} } }
        }
      }
    });
  }
}


// ===== TABLES =====
function initTables() {
  // Financial ‚Äî delegate to refreshFinTable so cost adjustments can also update it
  refreshFinTable(true);

  // Cohort
  const cohTb = document.getElementById('cohortTable');
  cohortes.forEach(c => {
    const r1 = (c.y1/c.init*100).toFixed(1), r2 = (c.y2/c.init*100).toFixed(1), r3 = (c.y3/c.init*100).toFixed(1);
    cohTb.innerHTML += `<tr>
      <td>${c.year}</td>
      <td>${(c.init/1e3).toFixed(0)}K</td>
      <td>${(c.y1/1e3).toFixed(0)}K</td>
      <td>${r1}%</td>
      <td>${(c.y2/1e3).toFixed(0)}K</td>
      <td>${r2}%</td>
      <td>${(c.y3/1e3).toFixed(0)}K</td>
      <td>${r3}%</td>
    </tr>`;
  });

  // KPI
  const kpiTb = document.getElementById('kpiTable');
  data.forEach((d, i) => {
    const prem = ((d.premium/d.users)*100).toFixed(1);
    const rpu = (d.revTotal/d.users).toFixed(2);
    const epu = (d.ebitda/d.users).toFixed(2);
    const cpu = (d.costs/d.users).toFixed(2);
    const margin = ((d.ebitda/d.revTotal)*100).toFixed(1);
    const yoy = i > 0 ? (((d.users - data[i-1].users)/data[i-1].users)*100).toFixed(1)+'%' : '‚Äî';
    kpiTb.innerHTML += `<tr>
      <td>${d.year}</td>
      <td>${(d.users/1e6).toFixed(2)}M</td>
      <td>${prem}%</td>
      <td>‚Ç¨${rpu}</td>
      <td>‚Ç¨${epu}</td>
      <td>‚Ç¨${cpu}</td>
      <td>${margin}%</td>
      <td class="up positive">${yoy}</td>
    </tr>`;
  });
}

// ===== SIMULATOR =====
let simChart;

function calcSimulator() {
  const ingresos = parseFloat(document.getElementById('ingresos').value)||0;
  const gastos = parseFloat(document.getElementById('gastos').value)||0;
  const saldoIni = parseFloat(document.getElementById('saldoInicial').value)||0;
  const pctInv = parseFloat(document.getElementById('pctInversion').value)||0;
  const rentInv = parseFloat(document.getElementById('rentInversion').value)||0;
  const inflacion = parseFloat(document.getElementById('inflacion').value)||0;
  const crIngresos = parseFloat(document.getElementById('crIngresos').value)||0;
  const horizon = parseInt(document.getElementById('horizon').value)||10;
  const gastosExtra = parseFloat(document.getElementById('gastosExtra').value)||0;

  const rows = [];
  let saldo = saldoIni;
  let cartera = 0;
  let ingMes = ingresos;
  let gastMes = gastos;

  for (let y = 1; y <= horizon; y++) {
    const ingAnual = ingMes * 12;
    const gastAnual = gastMes * 12 + gastosExtra;
    const ahorro = Math.max(0, ingAnual - gastAnual);
    const invertido = ahorro * (pctInv / 100);
    const liquidez = ahorro - invertido;

    cartera = cartera * (1 + rentInv/100) + invertido;
    saldo = saldo + liquidez;
    const total = saldo + cartera;

    rows.push({ y, ingAnual, gastAnual, ahorro, invertido, cartera, saldo, total });

    ingMes = ingMes * (1 + crIngresos/100);
    gastMes = gastMes * (1 + inflacion/100);
  }

  const last = rows[rows.length - 1];
  document.getElementById('resMensual').textContent = fmtFull(ingresos - gastos);
  document.getElementById('resPatrimonio').textContent = fmtFull(last.total);
  document.getElementById('resInversion').textContent = fmtFull(last.cartera);
  document.getElementById('resSaldo').textContent = fmtFull(last.saldo);

  // Update color
  const patEl = document.getElementById('resPatrimonio').parentElement;
  const ahMsg = ingresos > gastos;
  patEl.className = 'result-item ' + (ahMsg ? 'highlight-green' : 'highlight-red');

  // Table
  const tbl = document.getElementById('simTable');
  tbl.innerHTML = '';
  rows.forEach(r => {
    tbl.innerHTML += `<tr>
      <td>A√±o ${r.y}</td>
      <td>${fmtFull(r.ingAnual)}</td>
      <td>${fmtFull(r.gastAnual)}</td>
      <td>${fmtFull(r.ahorro)}</td>
      <td>${fmtFull(r.invertido)}</td>
      <td>${fmtFull(r.cartera)}</td>
      <td>${fmtFull(r.saldo)}</td>
      <td class="positive">${fmtFull(r.total)}</td>
    </tr>`;
  });

  // Chart
  const ctx = document.getElementById('chartSim');
  if (!ctx) return;
  if (ctx._chart) ctx._chart.destroy();
  ctx._chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: rows.map(r => 'A√±o '+r.y),
      datasets: [
        { label: 'Patrimonio Total', data: rows.map(r=>r.total), borderColor: COLORS.teal, backgroundColor: 'rgba(13,191,173,0.1)', fill: true, tension: 0.4, borderWidth: 2.5, pointRadius: 4 },
        { label: 'Cartera Inversi√≥n', data: rows.map(r=>r.cartera), borderColor: COLORS.blue, tension: 0.4, borderWidth: 2, pointRadius: 3, fill: false },
        { label: 'Saldo Liquidez', data: rows.map(r=>r.saldo), borderColor: COLORS.orange, tension: 0.4, borderWidth: 2, pointRadius: 3, fill: false }
      ]
    },
    options: { ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
      plugins: { ...CHART_DEFAULTS.plugins, tooltip: { callbacks: { label: c => c.dataset.label+': '+fmtFull(c.raw) } } },
      scales: { x: CHART_DEFAULTS.scales.x, y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => fmtFull(v), font:{family:'DM Sans',size:10} } } }
    }
  });
}

// ===== TAXES =====
function calcTaxes() {
  const tipo = document.getElementById('tipoActividad').value;
  const ingBrutos = parseFloat(document.getElementById('ingBrutos').value)||0;
  const gastosDed = parseFloat(document.getElementById('gastosDed').value)||0;
  const ivaRep = parseFloat(document.getElementById('ivaRep').value)||0;
  const ivaSop = parseFloat(document.getElementById('ivaSop').value)||0;
  const cuotaSS = parseFloat(document.getElementById('cuotaSS').value)||0;

  const baseImponible = ingBrutos - gastosDed - (cuotaSS * 12);
  const ivaNeto = Math.max(0, ivaRep - ivaSop);

  let irpfRate = 0, isRate = 0, irpf = 0, is = 0;

  if (tipo === 'autonomo') {
    // IRPF progresivo simplificado
    irpf = calcIRPF(Math.max(0, baseImponible));
    irpfRate = baseImponible > 0 ? (irpf / baseImponible * 100).toFixed(1) : 0;
  } else if (tipo === 'empresa') {
    isRate = 25;
    is = Math.max(0, baseImponible) * 0.25;
  } else { // startup
    isRate = 15;
    is = Math.max(0, baseImponible) * 0.15;
  }

  const totalFiscal = irpf + is + ivaNeto + cuotaSS * 12;
  const neto = ingBrutos - totalFiscal - (gastosDed);

  const summary = document.getElementById('taxSummary');
  summary.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px;padding:8px 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">Ingresos Brutos</span>
        <strong>${fmtFull(ingBrutos)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">Base Imponible</span>
        <strong>${fmtFull(Math.max(0, baseImponible))}</strong>
      </div>
      ${tipo === 'autonomo' ? `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">IRPF (${irpfRate}% efectivo)</span>
        <strong style="color:var(--red);">-${fmtFull(irpf)}</strong>
      </div>` : `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">IS (${isRate}%)</span>
        <strong style="color:var(--red);">-${fmtFull(is)}</strong>
      </div>`}
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">IVA Neto a Pagar</span>
        <strong style="color:var(--red);">-${fmtFull(ivaNeto)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--gray-100);">
        <span style="font-size:13px;color:var(--gray-700);">Seg. Social (anual)</span>
        <strong style="color:var(--red);">-${fmtFull(cuotaSS*12)}</strong>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;background:var(--green-light);border-radius:8px;padding:10px 14px;">
        <span style="font-size:14px;font-weight:700;color:var(--green);">Neto Estimado</span>
        <strong style="font-size:16px;font-family:'Syne',sans-serif;color:var(--green);">${fmtFull(Math.max(0,neto))}</strong>
      </div>
    </div>`;

  // Quarterly calendar
  const irpfQ = irpf / 4;
  const isQ = is / 4;
  const ivaQ = ivaNeto / 4;
  const ssQ = cuotaSS * 3;

  const quarters = [
    { q: '1T', dates: '1-20 Abril', desc: 'Pago Q1 2026' },
    { q: '2T', dates: '1-20 Julio', desc: 'Pago Q2 2026' },
    { q: '3T', dates: '1-20 Octubre', desc: 'Pago Q3 2026' },
    { q: '4T', dates: '1-30 Enero \'27', desc: 'Pago Q4 2026' }
  ];

  const cal = document.getElementById('taxCalendar');
  cal.innerHTML = '';
  quarters.forEach((qt, i) => {
    const irpfPago = tipo === 'autonomo' ? irpfQ : isQ;
    const totalQ = irpfPago + ivaQ + ssQ;
    const status = i < 2 ? 'paid' : i === 2 ? 'due' : 'pending';
    const statusLabel = { paid: 'Pagado ‚úì', due: 'Vence Pronto', pending: 'Pendiente' }[status];
    cal.innerHTML += `
      <div class="tax-q">
        <div class="tax-q-label">${qt.q}</div>
        <div class="tax-q-dates"><strong>${qt.dates}</strong><br>${qt.desc}</div>
        <div class="tax-q-amount">${fmtFull(totalQ)}</div>
        <div><span class="tax-q-status status-${status}">${statusLabel}</span></div>
      </div>`;
  });

  // Tax chart
  const ctx = document.getElementById('chartTax');
  if (!ctx) return;
  if (ctx._chart) ctx._chart.destroy();
  const taxTypes = tipo === 'autonomo'
    ? ['IRPF', 'IVA Neto', 'Seg. Social', 'Neto']
    : ['IS', 'IVA Neto', 'Seg. Social', 'Neto'];
  const taxVals = tipo === 'autonomo'
    ? [irpf, ivaNeto, cuotaSS*12, Math.max(0, neto)]
    : [is, ivaNeto, cuotaSS*12, Math.max(0, neto)];

  ctx._chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: taxTypes,
      datasets: [{ data: taxVals, backgroundColor: [COLORS.red, COLORS.orange, COLORS.blue, COLORS.teal], borderWidth: 2, borderColor: '#fff' }]
    },
    options: { responsive: true, maintainAspectRatio: false, cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { font:{family:'DM Sans',size:11}, boxWidth:10 } },
        tooltip: { callbacks: { label: c => c.label+': '+fmtFull(c.raw) } } }
    }
  });
}

function calcIRPF(base) {
  const tramos = [
    { hasta: 12450, tipo: 0.19 },
    { hasta: 20200, tipo: 0.24 },
    { hasta: 35200, tipo: 0.30 },
    { hasta: 60000, tipo: 0.37 },
    { hasta: 300000, tipo: 0.45 },
    { hasta: Infinity, tipo: 0.47 }
  ];
  let irpf = 0, prev = 0;
  for (const t of tramos) {
    if (base <= prev) break;
    const chunk = Math.min(base, t.hasta) - prev;
    irpf += chunk * t.tipo;
    prev = t.hasta;
  }
  return irpf;
}

// ===== NAVIGATION =====
function showSection(id, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (btn) btn.classList.add('active');
  // Init charts for this tab if not done yet, then resize all visible charts
  initChartsForTab(id);
  // If navigating to overview, sync with latest adjusted data
  if (id === 'overview') {
    const source = adjustedData.some(d => d._overridden) ? adjustedData : originalData;
    refreshOverview(source);
  }
  setTimeout(() => {
    document.querySelectorAll('#'+id+' canvas').forEach(canvas => {
      if (canvas._chart) canvas._chart.resize();
    });
  }, 30);
}

// ===== COST CORRECTION PANEL =====
// Cost categories as % of total costs (splits must sum to 1.0)
const COST_SPLITS = { personal: 0.45, tech: 0.20, marketing: 0.20, ops: 0.15 };
const originalCosts = originalData.map(d => d.costs); // store original cost values
let costCategory = 'total'; // currently selected category
let costAdjustedData = JSON.parse(JSON.stringify(originalData)); // working copy for costs

function getCostCategoryLabel(cat) {
  return { total: 'Coste Total', personal: 'Personal', tech: 'Tecnolog√≠a', marketing: 'Marketing', ops: 'Operaciones' }[cat] || cat;
}

function getCostCategoryPlaceholder(cat, costs) {
  const base = cat === 'total' ? costs : costs * COST_SPLITS[cat];
  return fmt(base) + ' (proyectado)';
}

function buildCostCorrectionGrid() {
  const grid = document.getElementById('costCorrectionGrid');
  grid.innerHTML = '';
  originalData.forEach((d) => {
    const projVal = costCategory === 'total' ? d.costs : d.costs * COST_SPLITS[costCategory];
    grid.innerHTML += `
      <div class="correction-field">
        <div class="year-tag">${d.year}</div>
        <label>${getCostCategoryLabel(costCategory)} (‚Ç¨)</label>
        <div class="cost-input-wrap">
          <input
            type="number"
            id="cost_${costCategory}_${d.year}"
            placeholder="${getCostCategoryPlaceholder(costCategory, d.costs)}"
            min="0"
            step="10000"
            oninput="onCostInput(${d.year}, this, '${costCategory}')"
          >
          <button class="cost-reset-btn" title="Restaurar a√±o" onclick="resetCostYear(${d.year}, '${costCategory}')">‚úï</button>
        </div>
        <span class="deviation-chip neutral" id="costchip_${costCategory}_${d.year}">Proyecci√≥n</span>
      </div>`;
  });
}

function setCostCategory(cat, btn) {
  costCategory = cat;
  document.querySelectorAll('.cost-cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  buildCostCorrectionGrid();
}

function onCostInput(year, inputEl, cat) {
  const val = inputEl.value.trim();
  const orig = originalData.find(d => d.year === year);
  const origVal = cat === 'total' ? orig.costs : orig.costs * COST_SPLITS[cat];
  const chip = document.getElementById(`costchip_${cat}_${year}`);

  if (val === '' || isNaN(parseFloat(val))) {
    inputEl.classList.remove('has-cost-override');
    chip.className = 'deviation-chip neutral';
    chip.textContent = 'Proyecci√≥n';
  } else {
    const real = parseFloat(val);
    const dev = ((real - origVal) / origVal * 100);
    inputEl.classList.add('has-cost-override');
    chip.className = 'deviation-chip ' + (dev <= 0 ? 'positive' : 'negative'); // less cost = positive!
    chip.textContent = (dev >= 0 ? '‚ñ≤ +' : '‚ñº ') + dev.toFixed(1) + '%';
  }
}

function resetCostYear(year, cat) {
  const inp = document.getElementById(`cost_${cat}_${year}`);
  if (inp) { inp.value = ''; inp.classList.remove('has-cost-override'); }
  const chip = document.getElementById(`costchip_${cat}_${year}`);
  if (chip) { chip.className = 'deviation-chip neutral'; chip.textContent = 'Proyecci√≥n'; }
}

function applyCostCorrections() {
  const cats = ['total', 'personal', 'tech', 'marketing', 'ops'];

  costAdjustedData = originalData.map((orig) => {
    let adjustedCosts = orig.costs;
    let hasOverride = false;

    // Check if total override exists
    const totalInp = document.getElementById(`cost_total_${orig.year}`);
    const totalVal = totalInp ? totalInp.value.trim() : '';
    if (totalVal !== '' && !isNaN(parseFloat(totalVal))) {
      adjustedCosts = parseFloat(totalVal);
      hasOverride = true;
    } else {
      // Check partial category overrides and reconstruct total
      let reconstructed = orig.costs;
      let partialOverride = false;
      for (const cat of ['personal', 'tech', 'marketing', 'ops']) {
        const inp = document.getElementById(`cost_${cat}_${orig.year}`);
        const v = inp ? inp.value.trim() : '';
        if (v !== '' && !isNaN(parseFloat(v))) {
          const origCatVal = orig.costs * COST_SPLITS[cat];
          const delta = parseFloat(v) - origCatVal;
          reconstructed += delta;
          partialOverride = true;
          hasOverride = true;
        }
      }
      if (partialOverride) adjustedCosts = Math.max(0, reconstructed);
    }

    const adjEbitda = orig.revTotal - adjustedCosts;
    return {
      ...orig,
      costs: adjustedCosts,
      ebitda: adjEbitda,
      _costOverridden: hasOverride,
      _costDelta: adjustedCosts - orig.costs
    };
  });

  // Update financial charts
  refreshCostCharts();
  showCostAdjustedTable();
  updateCostImpactBanner();

  // Badge
  const hasAny = costAdjustedData.some(d => d._costOverridden);
  const badge = document.getElementById('costModeBadge');
  badge.className = hasAny ? 'mode-badge cost-adjusted' : 'mode-badge original';
  badge.textContent = hasAny ? 'Costes Ajustados' : 'Modelo Original';

  // Also refresh main finTable with adjusted data
  refreshFinTable();
}

function resetCostCorrections() {
  costAdjustedData = JSON.parse(JSON.stringify(originalData));
  ['total','personal','tech','marketing','ops'].forEach(cat => {
    originalData.forEach(d => resetCostYear(d.year, cat));
  });
  buildCostCorrectionGrid();
  document.getElementById('costAdjustedCard').style.display = 'none';
  document.getElementById('costAdjustedChartCard').style.display = 'none';
  document.getElementById('costModeBadge').className = 'mode-badge original';
  document.getElementById('costModeBadge').textContent = 'Modelo Original';
  updateCostImpactBanner();
  refreshFinTable(true); // reset to original
}

function updateCostImpactBanner() {
  const origLast = originalData[9];
  const adjLast  = costAdjustedData[9];

  const costDelta   = ((adjLast.costs - origLast.costs) / origLast.costs * 100);
  const ebitdaDelta = ((adjLast.ebitda - origLast.ebitda) / origLast.ebitda * 100);
  const origMargin  = origLast.ebitda / origLast.revTotal * 100;
  const adjMargin   = adjLast.ebitda  / adjLast.revTotal  * 100;
  const count = costAdjustedData.filter(d => d._costOverridden).length;

  document.getElementById('costImpCosts').textContent = fmt(adjLast.costs);
  const cd = document.getElementById('costImpCostsDelta');
  cd.textContent = (costDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + Math.abs(costDelta).toFixed(1) + '% vs original';
  cd.className = 'id ' + (costDelta <= 0 ? 'up' : 'down'); // less cost = green

  document.getElementById('costImpEbitda').textContent = fmt(adjLast.ebitda);
  const ed = document.getElementById('costImpEbitdaDelta');
  ed.textContent = (ebitdaDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + Math.abs(ebitdaDelta).toFixed(1) + '% vs original';
  ed.className = 'id ' + (ebitdaDelta >= 0 ? 'up' : 'down');

  document.getElementById('costImpMargin').textContent = adjMargin.toFixed(1) + '%';
  const md = document.getElementById('costImpMarginDelta');
  const marginDelta = adjMargin - origMargin;
  md.textContent = (marginDelta >= 0 ? '‚ñ≤ +' : '‚ñº ') + Math.abs(marginDelta).toFixed(1) + 'pp vs original';
  md.className = 'id ' + (marginDelta >= 0 ? 'up' : 'down');

  document.getElementById('costImpCount').textContent = count || '‚Äî';
  document.getElementById('costImpCountLabel').textContent = count
    ? `a√±o${count > 1 ? 's' : ''} corregido${count > 1 ? 's' : ''}`
    : 'sin correcciones activas';
}

function showCostAdjustedTable() {
  document.getElementById('costAdjustedCard').style.display = 'block';
  document.getElementById('costAdjustedChartCard').style.display = 'block';

  const tbody = document.getElementById('costAdjustedTable');
  tbody.innerHTML = '';
  costAdjustedData.forEach((adj, i) => {
    const orig = originalData[i];
    const costDelta = adj.costs - orig.costs;
    const ebitdaDelta = adj.ebitda - orig.ebitda;
    const adjMargin = (adj.ebitda / adj.revTotal * 100).toFixed(1);
    const costDeltaPct = (costDelta / orig.costs * 100).toFixed(1);
    const ebitdaDeltaPct = (ebitdaDelta / orig.ebitda * 100).toFixed(1);

    tbody.innerHTML += `<tr${adj._costOverridden ? ' style="background:var(--orange-light);"' : ''}>
      <td>${adj.year}${adj._costOverridden ? ' üî∂' : ''}</td>
      <td>${fmt(adj.revTotal)}</td>
      <td>${fmt(orig.costs)}</td>
      <td><strong>${fmt(adj.costs)}</strong></td>
      <td class="${costDelta <= 0 ? 'positive' : 'negative'}">${costDelta >= 0 ? '+' : ''}${costDeltaPct}%</td>
      <td>${fmt(orig.ebitda)}</td>
      <td class="${adj.ebitda >= orig.ebitda ? 'positive' : 'negative'}"><strong>${fmt(adj.ebitda)}</strong></td>
      <td class="${ebitdaDelta >= 0 ? 'positive' : 'negative'}">${ebitdaDelta >= 0 ? '+' : ''}${ebitdaDeltaPct}%</td>
      <td>${adjMargin}%</td>
    </tr>`;
  });
}

function refreshCostCharts() {
  // Update the Costes vs Ingresos chart
  const cCtx = document.getElementById('chartCostes');
  if (cCtx && cCtx._chart) {
    cCtx._chart.data.datasets[1].data = costAdjustedData.map(d => d.costs/1e6);
    cCtx._chart.update();
  }

  // Update EBITDA acumulado chart
  let acum = 0;
  const acumAdj = costAdjustedData.map(d => { acum += d.ebitda; return acum/1e6; });
  const eaCtx = document.getElementById('chartEbitdaAcum');
  if (eaCtx && eaCtx._chart) {
    eaCtx._chart.data.datasets[0].data = acumAdj;
    eaCtx._chart.update();
  }

  // Build comparison chart: original EBITDA vs adjusted EBITDA
  const aCtx = document.getElementById('chartCostAdjusted');
  if (aCtx) {
    if (aCtx._chart) aCtx._chart.destroy();
    aCtx._chart = new Chart(aCtx, {
      type: 'bar',
      data: {
        labels: years,
        datasets: [
          {
            label: 'EBITDA Original',
            data: originalData.map(d => d.ebitda/1e6),
            backgroundColor: 'rgba(37,99,235,0.6)',
            borderRadius: 4
          },
          {
            label: 'EBITDA Ajustado',
            data: costAdjustedData.map(d => d.ebitda/1e6),
            backgroundColor: costAdjustedData.map(d =>
              d._costOverridden
                ? (d.ebitda >= originalData.find(o=>o.year===d.year).ebitda ? 'rgba(22,163,74,0.85)' : 'rgba(220,38,38,0.75)')
                : 'rgba(13,191,173,0.7)'
            ),
            borderRadius: 4
          },
          {
            label: 'Costes Ajustados',
            data: costAdjustedData.map(d => d.costs/1e6),
            backgroundColor: 'rgba(249,115,22,0.5)',
            borderRadius: 4,
            type: 'line',
            borderColor: COLORS.orange,
            borderWidth: 2.5,
            pointRadius: 5,
            pointBackgroundColor: costAdjustedData.map(d => d._costOverridden ? COLORS.orange : 'rgba(249,115,22,0.4)'),
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            fill: false,
            tension: 0.4,
            order: 0
          }
        ]
      },
      options: {
        ...CHART_DEFAULTS, responsive: true, maintainAspectRatio: false,
        plugins: {
          ...CHART_DEFAULTS.plugins,
          tooltip: { callbacks: { label: c => c.dataset.label + ': ‚Ç¨' + c.raw.toFixed(1) + 'M' } }
        },
        scales: {
          x: CHART_DEFAULTS.scales.x,
          y: { ...CHART_DEFAULTS.scales.y, ticks: { callback: v => '‚Ç¨'+v+'M', font:{family:'DM Sans',size:11} } }
        }
      }
    });
  }
}

function refreshFinTable(reset = false) {
  // Refresh the main financial table with cost-adjusted data
  const tbody = document.getElementById('finTable');
  if (!tbody) return;
  tbody.innerHTML = '';
  const source = reset ? originalData : costAdjustedData;
  source.forEach((d, i) => {
    const margin = ((d.ebitda/d.revTotal)*100).toFixed(1);
    const highlight = !reset && d._costOverridden ? ' style="background:var(--orange-light);"' : '';
    tbody.innerHTML += `<tr${highlight}>
      <td>${d.year}${!reset && d._costOverridden ? ' üî∂' : ''}</td>
      <td>${(d.users/1e6).toFixed(2)}M</td>
      <td>${fmt(d.revSub)}</td>
      <td>${fmt(d.revTx)}</td>
      <td>${fmt(d.revFx)}</td>
      <td>${fmt(d.revCard)}</td>
      <td><strong>${fmt(d.revTotal)}</strong></td>
      <td${!reset && d._costOverridden ? ' style="color:var(--orange);font-weight:700;"' : ''}>${fmt(d.costs)}</td>
      <td class="${d.ebitda >= 0 ? 'positive' : 'negative'}">${fmt(d.ebitda)}</td>
      <td>${margin}%</td>
    </tr>`;
  });
}


function downloadCSV() {
  const sheets = {
    "Resumen_Anual": {
      headers: ["A√±o","Usuarios Activos","Nuevos Usuarios","Churn","Starter","Premium",
                "Ingresos Suscripcion","Ingresos Transacciones","Ingresos FX-Cripto",
                "Ingresos Tarjetas","Total Ingresos","Costes Totales","EBITDA","Margen EBITDA %"],
      rows: data.map(d => [
        d.year, d.users, d.newUsers, d.churn, d.starter, d.premium,
        d.revSub, d.revTx, d.revFx, d.revCard, d.revTotal, d.costs, d.ebitda,
        ((d.ebitda/d.revTotal)*100).toFixed(2)+'%'
      ])
    },
    "KPIs_Anuales": {
      headers: ["A√±o","Usuarios","% Premium","Ingreso por Usuario (EUR)","EBITDA por Usuario (EUR)","Coste por Usuario (EUR)","Margen EBITDA %","Crecimiento YoY %"],
      rows: data.map((d, i) => [
        d.year, d.users,
        ((d.premium/d.users)*100).toFixed(2)+'%',
        (d.revTotal/d.users).toFixed(2),
        (d.ebitda/d.users).toFixed(2),
        (d.costs/d.users).toFixed(2),
        ((d.ebitda/d.revTotal)*100).toFixed(2)+'%',
        i > 0 ? (((d.users-data[i-1].users)/data[i-1].users)*100).toFixed(2)+'%' : '‚Äî'
      ])
    },
    "Cohortes": {
      headers: ["Cohorte","Usuarios Iniciales","A√±o +1","Retencion +1 %","A√±o +2","Retencion +2 %","A√±o +3","Retencion +3 %"],
      rows: cohortes.map(c => [
        c.year, c.init,
        c.y1, ((c.y1/c.init)*100).toFixed(2)+'%',
        c.y2, ((c.y2/c.init)*100).toFixed(2)+'%',
        c.y3, ((c.y3/c.init)*100).toFixed(2)+'%'
      ])
    },
    "KPIs_Estaticos": {
      headers: ["Indicador","Valor"],
      rows: [
        ["CAC Medio (EUR)", 19.5],
        ["LTV Medio (EUR)", 140],
        ["Ratio LTV/CAC", 7.18],
        ["Churn Anual (%)", "18.0%"],
      ]
    }
  };

  // Build multi-sheet CSV (separated by blank lines + sheet name)
  let csvContent = "\uFEFF"; // BOM for Excel UTF-8
  for (const [sheetName, { headers, rows }] of Object.entries(sheets)) {
    csvContent += `### ${sheetName} ###\n`;
    csvContent += headers.join(";") + "\n";
    rows.forEach(row => {
      csvContent += row.map(v => {
        const str = String(v ?? '');
        return str.includes(';') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"` : str;
      }).join(";") + "\n";
    });
    csvContent += "\n";
  }

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'FinX_Economics_2026-2035.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function downloadExcel() {
  // Build a minimal XLSX using SheetJS-style encoding inline (pure JS, no library needed)
  // We'll use a data URI with the pre-built Excel structure encoded as CSV-based XLSX
  // Since SheetJS is not loaded, we generate a rich HTML table that Excel opens natively
  const sheetName = "FinX Economics";

  const rows = [
    ["FinX ‚Äî Modelo de Proyecci√≥n Financiera 2026‚Äì2035", "", "", "", "", "", "", "", "", "", "", "", ""],
    ["Generado:", new Date().toLocaleDateString('es-ES'), "", "", "", "", "", "", "", "", "", "", ""],
    [""],
    ["RESUMEN ANUAL"],
    ["A√±o","Usuarios Activos","Nuevos Usuarios","Churn","Starter","Premium",
     "Ing. Suscripci√≥n (‚Ç¨)","Ing. Transacciones (‚Ç¨)","Ing. FX/Cripto (‚Ç¨)","Ing. Tarjetas (‚Ç¨)",
     "Total Ingresos (‚Ç¨)","Costes Totales (‚Ç¨)","EBITDA (‚Ç¨)","Margen EBITDA %"],
    ...data.map(d => [
      d.year, d.users, d.newUsers, d.churn, d.starter, d.premium,
      d.revSub, d.revTx, d.revFx, d.revCard, d.revTotal, d.costs, d.ebitda,
      +((d.ebitda/d.revTotal)*100).toFixed(2)
    ]),
    [""],
    ["KPIs ANUALES"],
    ["A√±o","Usuarios","% Premium","Rev/Usuario ‚Ç¨","EBITDA/Usuario ‚Ç¨","Coste/Usuario ‚Ç¨","Margen %","Crec. YoY %"],
    ...data.map((d,i) => [
      d.year, d.users,
      +((d.premium/d.users)*100).toFixed(2),
      +(d.revTotal/d.users).toFixed(2),
      +(d.ebitda/d.users).toFixed(2),
      +(d.costs/d.users).toFixed(2),
      +((d.ebitda/d.revTotal)*100).toFixed(2),
      i > 0 ? +(((d.users-data[i-1].users)/data[i-1].users)*100).toFixed(2) : ''
    ]),
    [""],
    ["COHORTES DE USUARIOS"],
    ["Cohorte","Usuarios Iniciales","A√±o +1","Retenci√≥n +1 %","A√±o +2","Retenci√≥n +2 %","A√±o +3","Retenci√≥n +3 %"],
    ...cohortes.map(c => [
      c.year, c.init,
      c.y1, +((c.y1/c.init)*100).toFixed(2),
      c.y2, +((c.y2/c.init)*100).toFixed(2),
      c.y3, +((c.y3/c.init)*100).toFixed(2)
    ]),
    [""],
    ["KPIs ESTRAT√âGICOS"],
    ["Indicador","Valor","Benchmark","Estado"],
    ["CAC Medio (‚Ç¨)", 19.5, "< 30 ‚Ç¨", "‚úÖ Excelente"],
    ["LTV Medio (‚Ç¨)", 140, "> 100 ‚Ç¨", "‚úÖ Excelente"],
    ["Ratio LTV/CAC", 7.18, "> 3x", "‚úÖ World-class"],
    ["Churn Anual", 0.18, "< 15%", "‚ö†Ô∏è Mejorable"],
    ["Margen EBITDA 2026", +((data[0].ebitda/data[0].revTotal)*100).toFixed(2), "> 40%", "‚úÖ World-class"],
    ["Margen EBITDA 2035", +((data[9].ebitda/data[9].revTotal)*100).toFixed(2), "> 40%", "‚úÖ World-class"],
  ];

  // Build HTML table that Excel can open as xlsx
  let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office"
    xmlns:x="urn:schemas-microsoft-com:office:excel"
    xmlns="http://www.w3.org/TR/REC-html40">
  <head>
    <meta charset="UTF-8">
    <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>
      <x:ExcelWorksheet><x:Name>FinX Economics</x:Name>
      <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
      </x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
    <style>
      body { font-family: Arial, sans-serif; font-size: 10pt; }
      .title { font-size: 14pt; font-weight: bold; background: #1E293B; color: white; }
      .section { font-size: 11pt; font-weight: bold; background: #0DBFAD; color: white; }
      .hdr { font-weight: bold; background: #1E293B; color: white; text-align: center; }
      .alt { background: #F9FAFB; }
      .num { text-align: right; }
      .year { font-weight: bold; color: #2563EB; text-align: center; }
      td, th { padding: 4px 8px; border: 1px solid #E5E7EB; }
    </style>
  </head><body><table>`;

  rows.forEach((row, ri) => {
    if (row.length === 0 || (row.length === 1 && row[0] === "")) {
      html += '<tr><td colspan="14">&nbsp;</td></tr>';
      return;
    }
    const isTitle   = ri === 0;
    const isSection = typeof row[0] === 'string' && row.length === 1 && row[0].toUpperCase() === row[0];
    const isHdr     = typeof row[0] === 'string' && (row[0] === 'A√±o' || row[0] === 'Cohorte' || row[0] === 'Indicador');

    html += '<tr>';
    row.forEach((cell, ci) => {
      const cls = isTitle ? 'title' : isSection ? 'section' : isHdr ? 'hdr' : (ci === 0 ? 'year' : 'num');
      const tag = isHdr ? 'th' : 'td';
      const val = cell === null || cell === undefined ? '' : cell;
      html += `<${tag} class="${cls}">${val}</${tag}>`;
    });
    html += '</tr>';
  });

  html += '</table></body></html>';

  const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'FinX_Economics_2026-2035.xls';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


window.addEventListener('load', () => {
  buildCorrectionGrid();
  updateImpactBanner();
  buildCostCorrectionGrid();
  updateCostImpactBanner();
  initTables();
  calcSimulator();
  calcTaxes();
  // Init charts for the default active tab (overview)
  initChartsForTab('overview');
});
</script>
</body>
</html>
